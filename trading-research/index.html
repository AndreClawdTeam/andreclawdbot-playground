<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ğŸ¤– Trading Bot â€” Fonte da Verdade</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg:       #09090b;
      --bg2:      #111113;
      --bg3:      #18181b;
      --bg4:      #27272a;
      --border:   #3f3f46;
      --text:     #fafafa;
      --muted:    #a1a1aa;
      --accent:   #6366f1;
      --accent2:  #8b5cf6;
      --green:    #22c55e;
      --yellow:   #eab308;
      --red:      #ef4444;
      --orange:   #f97316;
      --cyan:     #06b6d4;
      --pink:     #ec4899;
    }

    html { scroll-behavior: smooth; }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Inter', 'Segoe UI', system-ui, sans-serif;
      line-height: 1.6;
      min-height: 100vh;
    }

    /* â”€â”€ HEADER â”€â”€ */
    header {
      position: relative;
      overflow: hidden;
      padding: 80px 24px 60px;
      text-align: center;
      background: linear-gradient(135deg, #09090b 0%, #1a1027 50%, #09090b 100%);
      border-bottom: 1px solid var(--border);
    }

    .header-glow {
      position: absolute;
      top: -40%;
      left: 50%;
      transform: translateX(-50%);
      width: 600px;
      height: 600px;
      border-radius: 50%;
      background: radial-gradient(circle, rgba(99,102,241,0.25) 0%, transparent 70%);
      animation: pulse-glow 4s ease-in-out infinite;
      pointer-events: none;
    }

    @keyframes pulse-glow {
      0%, 100% { opacity: 0.6; transform: translateX(-50%) scale(1); }
      50%       { opacity: 1;   transform: translateX(-50%) scale(1.15); }
    }

    .header-grid {
      position: absolute;
      inset: 0;
      background-image:
        linear-gradient(rgba(99,102,241,0.07) 1px, transparent 1px),
        linear-gradient(90deg, rgba(99,102,241,0.07) 1px, transparent 1px);
      background-size: 40px 40px;
      mask-image: radial-gradient(ellipse 80% 80% at 50% 50%, black 40%, transparent 100%);
    }

    .header-content { position: relative; z-index: 1; }

    header h1 {
      font-size: clamp(2rem, 5vw, 3.5rem);
      font-weight: 800;
      letter-spacing: -1px;
      background: linear-gradient(135deg, #a5b4fc 0%, #c084fc 50%, #f0abfc 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      animation: fadeInDown 0.8s ease both;
    }

    header p.subtitle {
      margin-top: 16px;
      color: var(--muted);
      font-size: 1.1rem;
      animation: fadeInDown 0.8s 0.2s ease both;
    }

    .header-badges {
      display: flex;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
      margin-top: 24px;
      animation: fadeInDown 0.8s 0.4s ease both;
    }

    .badge {
      padding: 4px 14px;
      border-radius: 999px;
      font-size: 0.78rem;
      font-weight: 600;
      letter-spacing: 0.5px;
      border: 1px solid;
    }

    .badge-indigo { background: rgba(99,102,241,0.15); border-color: rgba(99,102,241,0.4); color: #a5b4fc; }
    .badge-green  { background: rgba(34,197,94,0.12);  border-color: rgba(34,197,94,0.35);  color: #86efac; }
    .badge-yellow { background: rgba(234,179,8,0.12);  border-color: rgba(234,179,8,0.35);  color: #fde047; }
    .badge-cyan   { background: rgba(6,182,212,0.12);  border-color: rgba(6,182,212,0.35);  color: #67e8f9; }
    .badge-red    { background: rgba(239,68,68,0.12);  border-color: rgba(239,68,68,0.35);  color: #fca5a5; }

    @keyframes fadeInDown {
      from { opacity: 0; transform: translateY(-20px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    /* â”€â”€ NAV â”€â”€ */
    nav {
      position: sticky;
      top: 0;
      z-index: 100;
      background: rgba(9,9,11,0.9);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--border);
      padding: 0 24px;
      overflow-x: auto;
    }

    .nav-inner {
      display: flex;
      gap: 2px;
      max-width: 1200px;
      margin: 0 auto;
      white-space: nowrap;
    }

    nav a {
      display: inline-block;
      padding: 14px 14px;
      color: var(--muted);
      text-decoration: none;
      font-size: 0.78rem;
      font-weight: 500;
      border-bottom: 2px solid transparent;
      transition: color 0.2s, border-color 0.2s;
    }

    nav a:hover { color: var(--text); border-color: var(--accent); }

    /* â”€â”€ LAYOUT â”€â”€ */
    main {
      max-width: 1100px;
      margin: 0 auto;
      padding: 48px 24px 80px;
      display: flex;
      flex-direction: column;
      gap: 64px;
    }

    /* â”€â”€ SECTION â”€â”€ */
    .section-header {
      display: flex;
      align-items: center;
      gap: 14px;
      margin-bottom: 32px;
    }

    .section-icon {
      width: 44px;
      height: 44px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.4rem;
      flex-shrink: 0;
    }

    .icon-indigo { background: rgba(99,102,241,0.2); }
    .icon-green  { background: rgba(34,197,94,0.2); }
    .icon-yellow { background: rgba(234,179,8,0.2); }
    .icon-cyan   { background: rgba(6,182,212,0.2); }
    .icon-orange { background: rgba(249,115,22,0.2); }
    .icon-red    { background: rgba(239,68,68,0.2); }
    .icon-pink   { background: rgba(236,72,153,0.2); }
    .icon-purple { background: rgba(139,92,246,0.2); }

    .section-header h2 {
      font-size: 1.6rem;
      font-weight: 700;
      letter-spacing: -0.5px;
    }

    /* â”€â”€ CARDS â”€â”€ */
    .cards-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 16px;
    }

    .card {
      background: var(--bg3);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      transition: border-color 0.3s, transform 0.3s, box-shadow 0.3s;
    }

    .card:hover {
      border-color: var(--accent);
      transform: translateY(-4px);
      box-shadow: 0 12px 40px rgba(99,102,241,0.15);
    }

    .card-title {
      font-weight: 700;
      font-size: 1rem;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .card p { color: var(--muted); font-size: 0.9rem; line-height: 1.7; }

    /* â”€â”€ TABLE â”€â”€ */
    .table-wrap { overflow-x: auto; }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.88rem;
    }

    th {
      text-align: left;
      padding: 12px 16px;
      background: var(--bg4);
      color: var(--muted);
      font-weight: 600;
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      border-bottom: 1px solid var(--border);
    }

    th:first-child { border-radius: 10px 0 0 0; }
    th:last-child  { border-radius: 0 10px 0 0; }

    td {
      padding: 14px 16px;
      border-bottom: 1px solid var(--border);
      color: var(--muted);
    }

    tr:hover td { background: var(--bg4); color: var(--text); }

    tr:last-child td:first-child { border-radius: 0 0 0 10px; }
    tr:last-child td:last-child  { border-radius: 0 0 10px 0; }

    .tag {
      display: inline-block;
      padding: 2px 10px;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .tag-green  { background: rgba(34,197,94,0.15);  color: #86efac; }
    .tag-yellow { background: rgba(234,179,8,0.15);  color: #fde047; }
    .tag-red    { background: rgba(239,68,68,0.15);  color: #fca5a5; }
    .tag-indigo { background: rgba(99,102,241,0.15); color: #a5b4fc; }

    /* â”€â”€ WARNING / INFO BOXES â”€â”€ */
    .warning-box {
      background: rgba(239,68,68,0.08);
      border: 1px solid rgba(239,68,68,0.3);
      border-radius: 14px;
      padding: 24px;
      margin-bottom: 16px;
    }

    .warning-box h3 {
      color: var(--red);
      font-size: 1rem;
      font-weight: 700;
      margin-bottom: 10px;
    }

    .warning-box p { color: var(--muted); font-size: 0.9rem; line-height: 1.7; }

    .info-box {
      background: rgba(99,102,241,0.08);
      border: 1px solid rgba(99,102,241,0.3);
      border-radius: 14px;
      padding: 24px;
      margin-bottom: 16px;
    }

    .info-box h3 {
      color: var(--accent);
      font-size: 1rem;
      font-weight: 700;
      margin-bottom: 10px;
    }

    .info-box p { color: var(--muted); font-size: 0.9rem; line-height: 1.7; }

    .success-box {
      background: rgba(34,197,94,0.08);
      border: 1px solid rgba(34,197,94,0.3);
      border-radius: 14px;
      padding: 24px;
      margin-bottom: 16px;
    }

    .success-box h3 {
      color: var(--green);
      font-size: 1rem;
      font-weight: 700;
      margin-bottom: 10px;
    }

    .success-box p { color: var(--muted); font-size: 0.9rem; line-height: 1.7; }

    /* â”€â”€ CODE BLOCKS â”€â”€ */
    .code-wrap {
      position: relative;
      margin: 16px 0;
    }

    .code-label {
      display: inline-block;
      padding: 4px 12px;
      background: var(--bg4);
      border: 1px solid var(--border);
      border-bottom: none;
      border-radius: 8px 8px 0 0;
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--muted);
      font-family: 'JetBrains Mono', 'Fira Code', monospace;
    }

    pre {
      background: #0d0d10;
      border: 1px solid var(--border);
      border-radius: 0 12px 12px 12px;
      padding: 24px;
      font-family: 'JetBrains Mono', 'Fira Code', 'Courier New', monospace;
      font-size: 0.8rem;
      color: #e2e8f0;
      overflow-x: auto;
      line-height: 1.7;
      white-space: pre;
      word-break: normal;
    }

    pre.no-label {
      border-radius: 12px;
    }

    .code-block-simple {
      background: #0d0d10;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      font-family: 'JetBrains Mono', 'Fira Code', 'Courier New', monospace;
      font-size: 0.8rem;
      color: #e2e8f0;
      overflow-x: auto;
      line-height: 1.7;
      margin: 16px 0;
    }

    code {
      background: var(--bg4);
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 0.85em;
      color: #a5b4fc;
      font-family: 'JetBrains Mono', 'Fira Code', monospace;
    }

    /* â”€â”€ RISK ITEMS â”€â”€ */
    .risk-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 16px;
    }

    .risk-item {
      background: var(--bg3);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 20px;
      border-left: 4px solid var(--red);
      transition: border-color 0.2s, transform 0.2s;
    }

    .risk-item:hover { transform: translateY(-2px); border-color: var(--red); }

    .risk-item-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }

    .risk-item-num {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: rgba(239,68,68,0.2);
      border: 1px solid rgba(239,68,68,0.4);
      color: var(--red);
      font-size: 0.75rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .risk-item-title {
      font-weight: 700;
      font-size: 0.95rem;
    }

    .risk-item p {
      color: var(--muted);
      font-size: 0.87rem;
      line-height: 1.6;
    }

    .risk-value {
      display: inline-block;
      margin-top: 10px;
      padding: 4px 12px;
      background: rgba(239,68,68,0.1);
      border: 1px solid rgba(239,68,68,0.3);
      border-radius: 6px;
      font-size: 0.8rem;
      color: #fca5a5;
      font-family: 'JetBrains Mono', monospace;
      font-weight: 600;
    }

    /* â”€â”€ STAT CARDS â”€â”€ */
    .stat-row {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 12px;
      margin-bottom: 32px;
    }

    .stat-card {
      background: var(--bg3);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 20px;
      text-align: center;
    }

    .stat-value {
      font-size: 1.8rem;
      font-weight: 800;
      background: linear-gradient(135deg, #a5b4fc, #c084fc);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .stat-label { font-size: 0.78rem; color: var(--muted); margin-top: 4px; }

    /* â”€â”€ STEP LIST â”€â”€ */
    .step-list {
      counter-reset: steps;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .step {
      counter-increment: steps;
      display: flex;
      gap: 16px;
      align-items: flex-start;
    }

    .step-num {
      flex-shrink: 0;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: rgba(99,102,241,0.2);
      border: 1px solid rgba(99,102,241,0.4);
      color: var(--accent);
      font-size: 0.85rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .step-content h4 {
      font-size: 0.95rem;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .step-content p {
      color: var(--muted);
      font-size: 0.88rem;
      line-height: 1.6;
    }

    /* â”€â”€ ARCH DIAGRAM â”€â”€ */
    .arch-ascii {
      background: #0d0d10;
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 32px;
      font-family: 'JetBrains Mono', 'Fira Code', monospace;
      font-size: 0.82rem;
      line-height: 1.8;
      color: #a5b4fc;
      overflow-x: auto;
    }

    /* â”€â”€ GRID VISUALIZER â”€â”€ */
    .grid-viz {
      background: var(--bg3);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 32px;
      font-family: 'JetBrains Mono', 'Fira Code', monospace;
      font-size: 0.82rem;
    }

    /* â”€â”€ COLLAPSIBLE SOURCE â”€â”€ */
    .source-file {
      background: var(--bg3);
      border: 1px solid var(--border);
      border-radius: 16px;
      overflow: hidden;
      margin-bottom: 16px;
    }

    .source-trigger {
      width: 100%;
      background: none;
      border: none;
      padding: 20px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      color: var(--text);
      font-size: 0.95rem;
      font-weight: 600;
      text-align: left;
      transition: background 0.2s;
    }

    .source-trigger:hover { background: var(--bg4); }
    .source-trigger-left { display: flex; align-items: center; gap: 12px; }

    .source-chevron {
      transition: transform 0.3s;
      color: var(--muted);
      flex-shrink: 0;
    }

    .source-file.open .source-chevron { transform: rotate(180deg); }

    .source-body {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.4s ease;
    }

    .source-body pre {
      border-radius: 0;
      border: none;
      border-top: 1px solid var(--border);
      margin: 0;
      max-height: 600px;
      overflow-y: auto;
    }

    /* â”€â”€ FOOTER â”€â”€ */
    footer {
      border-top: 1px solid var(--border);
      padding: 32px 24px;
      text-align: center;
      color: var(--muted);
      font-size: 0.82rem;
    }

    footer span { color: var(--accent); }

    /* â”€â”€ MISC â”€â”€ */
    .text-green  { color: var(--green); }
    .text-yellow { color: var(--yellow); }
    .text-red    { color: var(--red); }
    .text-cyan   { color: var(--cyan); }
    .text-accent { color: var(--accent); }
    .text-muted  { color: var(--muted); }
    .fw700       { font-weight: 700; }

    .divider {
      height: 1px;
      background: linear-gradient(to right, transparent, var(--border), transparent);
    }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: var(--bg); }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--muted); }

    /* Scroll animation */
    .animate-on-scroll {
      opacity: 0;
      transform: translateY(30px);
      transition: opacity 0.6s ease, transform 0.6s ease;
    }
    .animate-on-scroll.visible {
      opacity: 1;
      transform: translateY(0);
    }

    ul.styled { padding-left: 20px; color: var(--muted); font-size: 0.9rem; line-height: 1.8; }
    ul.styled li { margin-bottom: 4px; }

    .two-col {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }
    @media (max-width: 640px) { .two-col { grid-template-columns: 1fr; } }

    .file-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 3px 10px;
      background: rgba(99,102,241,0.15);
      border: 1px solid rgba(99,102,241,0.3);
      border-radius: 6px;
      font-size: 0.75rem;
      color: #a5b4fc;
      font-family: 'JetBrains Mono', monospace;
    }

    .inline-links { display: flex; gap: 12px; flex-wrap: wrap; margin-top: 16px; }
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 20px;
      border-radius: 8px;
      text-decoration: none;
      font-weight: 600;
      font-size: 0.875rem;
      transition: opacity 0.2s;
    }
    .btn:hover { opacity: 0.85; }
    .btn-primary { background: var(--accent); color: #fff; }
    .btn-secondary { background: var(--bg4); color: var(--text); border: 1px solid var(--border); }
    .btn-green { background: rgba(34,197,94,0.2); color: var(--green); border: 1px solid rgba(34,197,94,0.3); }
  </style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â• HEADER â•â•â•â•â•â•â•â•â•â•â• -->
<header>
  <div class="header-grid"></div>
  <div class="header-glow"></div>
  <div class="header-content">
    <h1>ğŸ¤– AndreClawdTeam Trading Bot</h1>
    <p class="subtitle">Fonte da Verdade â€” DocumentaÃ§Ã£o tÃ©cnica completa da implementaÃ§Ã£o atual</p>
    <div class="header-badges">
      <span class="badge badge-green">âœ… LIVE â€” Paper Mode Ativo</span>
      <span class="badge badge-indigo">6 Coins | $120 USDT</span>
      <span class="badge badge-cyan">OKX Â· KuCoin Â· Gate.io</span>
      <span class="badge badge-yellow">VPS 138.197.19.184</span>
      <span class="badge badge-red">Rodando desde 20/02/2026</span>
    </div>
    <div class="inline-links" style="justify-content:center;margin-top:24px;">
      <a href="http://138.197.19.184:8766" target="_blank" class="btn btn-primary">ğŸ“Š Dashboard ao Vivo</a>
      <a href="https://github.com/AndreClawdTeam/trading-bot" target="_blank" class="btn btn-secondary">ğŸ’» GitHub Repo</a>
    </div>
  </div>
</header>

<!-- â•â•â•â•â•â•â•â•â•â•â• NAV â•â•â•â•â•â•â•â•â•â•â• -->
<nav>
  <div class="nav-inner">
    <a href="#o-que-e">O que Ã©</a>
    <a href="#arquitetura">Arquitetura</a>
    <a href="#coins">Coins</a>
    <a href="#grid">Como o Grid Funciona</a>
    <a href="#risco">Sistema de Risco</a>
    <a href="#banco">Banco de Dados</a>
    <a href="#codigo">CÃ³digo Fonte</a>
    <a href="#systemd">Systemd</a>
    <a href="#dashboard">Dashboard</a>
    <a href="#notificacoes">NotificaÃ§Ãµes</a>
    <a href="#recriar">Como Recriar</a>
    <a href="#live">Ir para Live</a>
    <a href="#comandos">Comandos Ãšteis</a>
    <a href="#estado">Estado Atual</a>
  </div>
</nav>

<!-- â•â•â•â•â•â•â•â•â•â•â• MAIN â•â•â•â•â•â•â•â•â•â•â• -->
<main>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SEÃ‡ÃƒO 1 â€” O QUE Ã‰
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<section id="o-que-e" class="animate-on-scroll">
  <div class="section-header">
    <div class="section-icon icon-indigo">ğŸ¯</div>
    <h2>O que Ã©</h2>
  </div>

  <div class="stat-row">
    <div class="stat-card">
      <div class="stat-value">6</div>
      <div class="stat-label">Coins ativas</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">$120</div>
      <div class="stat-label">Capital total (USDT)</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">10</div>
      <div class="stat-label">NÃ­veis por grid</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">24/7</div>
      <div class="stat-label">OperaÃ§Ã£o contÃ­nua</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">3</div>
      <div class="stat-label">Exchanges (fallback)</div>
    </div>
  </div>

  <div class="cards-grid">
    <div class="card">
      <div class="card-title">ğŸ“‹ DescriÃ§Ã£o Geral</div>
      <p>Bot de <strong>grid trading multi-coin</strong> rodando em paper mode 24/7 em uma VPS DigitalOcean (Ubuntu 22.04). Opera 6 memecoins simultÃ¢neas com capital isolado de $20 por coin, capturando oscilaÃ§Ãµes de preÃ§o repetidamente dentro de uma grade de ordens espaÃ§adas.</p>
    </div>
    <div class="card">
      <div class="card-title">ğŸ¦ Exchanges</div>
      <p>Usa apenas <strong>APIs pÃºblicas de preÃ§o</strong> (paper mode â€” sem execuÃ§Ã£o real). <strong>OKX</strong> Ã© a fonte primÃ¡ria de preÃ§os. <strong>KuCoin</strong> Ã© o fallback automÃ¡tico. <strong>Gate.io</strong> Ã© o fallback terciÃ¡rio. Binance e Bybit sÃ£o geo-bloqueadas nesta VPS (testado em 20/02/2026).</p>
    </div>
    <div class="card">
      <div class="card-title">ğŸ›¡ï¸ Sistema de Risco</div>
      <p>Cada coin opera de forma <strong>completamente independente</strong> com seu prÃ³prio capital. Seis mecanismos de proteÃ§Ã£o por coin: strike system, daily loss limit, stop-loss mode, stop-loss total, balance floor e global circuit breaker. Se uma coin for desabilitada, as outras continuam.</p>
    </div>
    <div class="card">
      <div class="card-title">ğŸ”” NotificaÃ§Ãµes</div>
      <p>Eventos importantes geram notificaÃ§Ãµes automÃ¡ticas via <strong>Telegram</strong> (chat do AndrÃ©). Isso inclui: bot iniciado, coin desabilitada por risco, stop-loss ativado, strikes de drawdown. Implementado via <code>openclaw message send</code> por subprocess.</p>
    </div>
  </div>
</section>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SEÃ‡ÃƒO 2 â€” ARQUITETURA
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<section id="arquitetura" class="animate-on-scroll">
  <div class="section-header">
    <div class="section-icon icon-cyan">ğŸ—ï¸</div>
    <h2>Arquitetura</h2>
  </div>

  <div class="arch-ascii">
<pre style="background:transparent;border:none;border-radius:0;padding:0;color:#a5b4fc;">
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                  VPS â€” 138.197.19.184 (Ubuntu 22.04)                 â”‚
  â”‚                                                                      â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
  â”‚  â”‚  trading-bot.service  (systemd user service)                â”‚    â”‚
  â”‚  â”‚                                                             â”‚    â”‚
  â”‚  â”‚   bot.py (main loop, 10s interval)                          â”‚    â”‚
  â”‚  â”‚     â”‚                                                        â”‚    â”‚
  â”‚  â”‚     â”œâ”€â”€ is_trading_enabled() â”€â”€â–º bot_state (PostgreSQL)     â”‚    â”‚
  â”‚  â”‚     â”‚                                                        â”‚    â”‚
  â”‚  â”‚     â”œâ”€â”€ exchange.py â”€â”€â–º OKX REST API  (primÃ¡rio)            â”‚    â”‚
  â”‚  â”‚     â”‚                â”œâ–º KuCoin REST API (fallback)          â”‚    â”‚
  â”‚  â”‚     â”‚                â””â–º Gate.io REST API (terciÃ¡rio)        â”‚    â”‚
  â”‚  â”‚     â”‚                                                        â”‚    â”‚
  â”‚  â”‚     â”œâ”€â”€ GridBot[PEPE]  â”€â”€â”                                  â”‚    â”‚
  â”‚  â”‚     â”œâ”€â”€ GridBot[SHIB]    â”‚                                  â”‚    â”‚
  â”‚  â”‚     â”œâ”€â”€ GridBot[BONK]    â”œâ”€â”€ database.py â”€â”€â–º PostgreSQL 16  â”‚    â”‚
  â”‚  â”‚     â”œâ”€â”€ GridBot[FLOKI]   â”‚   (trades, daily_results,        â”‚    â”‚
  â”‚  â”‚     â”œâ”€â”€ GridBot[DOGE]    â”‚    total_results,                â”‚    â”‚
  â”‚  â”‚     â””â”€â”€ GridBot[WIF]  â”€â”€â”˜    disabled_symbols, bot_state)  â”‚    â”‚
  â”‚  â”‚                                                             â”‚    â”‚
  â”‚  â”‚     â””â”€â”€ notifier.py â”€â”€â–º openclaw CLI â”€â”€â–º Telegram           â”‚    â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
  â”‚                                                                      â”‚
  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
  â”‚  â”‚  trading-dashboard.service  (Flask, porta 8766)             â”‚    â”‚
  â”‚  â”‚                                                             â”‚    â”‚
  â”‚  â”‚   dashboard.py â”€â”€â–º PostgreSQL (read-only)                   â”‚    â”‚
  â”‚  â”‚   Rotas:  /  (HTML)  |  /api/stats  |  /api/daily-pnl-by-coin  â”‚  â”‚
  â”‚  â”‚           /api/resume/&lt;symbol&gt;  (reabilita coin)            â”‚    â”‚
  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
  â”‚                                                                      â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

  Ficheiros do projeto:
  /home/clawdbot/workspace/coding/trading-bot/
    â”œâ”€â”€ config.py      â† Toda a configuraÃ§Ã£o (coins, risk, DB URL)
    â”œâ”€â”€ strategy.py    â† GridBot class (lÃ³gica de grid + risk checks)
    â”œâ”€â”€ bot.py         â† Main loop multi-coin + circuit breaker
    â”œâ”€â”€ exchange.py    â† PreÃ§os de OKX/KuCoin/Gate.io
    â”œâ”€â”€ database.py    â† PostgreSQL layer (CRUD, ensure_tables)
    â”œâ”€â”€ notifier.py    â† Telegram via openclaw CLI subprocess
    â”œâ”€â”€ dashboard.py   â† Flask dashboard (porta 8766, ~600 linhas)
    â””â”€â”€ requirements.txt
</pre>
  </div>

  <div style="margin-top:24px;" class="two-col">
    <div class="info-box" style="margin-bottom:0;">
      <h3>ğŸ Python Environment</h3>
      <p>
        <strong>Bot:</strong> <code>/home/clawdbot/.openclaw/workspace/venv/bin/python3</code><br/>
        <strong>Dashboard:</strong> <code>/home/linuxbrew/.linuxbrew/bin/python3</code><br/>
        Dois ambientes separados por compatibilidade de dependÃªncias.
      </p>
    </div>
    <div class="info-box" style="margin-bottom:0;">
      <h3>ğŸ—„ï¸ Banco de Dados</h3>
      <p>
        <strong>PostgreSQL 16</strong> gerenciado pelo systemd (serviÃ§o do sistema).<br/>
        Database: <code>trading</code><br/>
        User: <code>andre</code><br/>
        Port: <code>5432</code> (local only)
      </p>
    </div>
  </div>
</section>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SEÃ‡ÃƒO 3 â€” CONFIGURAÃ‡ÃƒO DAS COINS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<section id="coins" class="animate-on-scroll">
  <div class="section-header">
    <div class="section-icon icon-yellow">ğŸª™</div>
    <h2>ConfiguraÃ§Ã£o das Coins</h2>
  </div>

  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>Coin</th>
          <th>Par</th>
          <th>EspaÃ§amento Grid</th>
          <th>NÃ­veis</th>
          <th>Ordem / lado</th>
          <th>Capital Alocado</th>
          <th>Categoria</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td class="fw700">PEPE</td>
          <td><code>PEPE/USDT</code></td>
          <td class="text-green">0.2%</td>
          <td>10</td>
          <td>$1.00 USDT</td>
          <td class="text-cyan fw700">$20</td>
          <td><span class="tag tag-indigo">micro-cap meme</span></td>
        </tr>
        <tr>
          <td class="fw700">SHIB</td>
          <td><code>SHIB/USDT</code></td>
          <td class="text-green">0.2%</td>
          <td>10</td>
          <td>$1.00 USDT</td>
          <td class="text-cyan fw700">$20</td>
          <td><span class="tag tag-indigo">micro-cap meme</span></td>
        </tr>
        <tr>
          <td class="fw700">BONK</td>
          <td><code>BONK/USDT</code></td>
          <td class="text-green">0.2%</td>
          <td>10</td>
          <td>$1.00 USDT</td>
          <td class="text-cyan fw700">$20</td>
          <td><span class="tag tag-indigo">micro-cap meme</span></td>
        </tr>
        <tr>
          <td class="fw700">FLOKI</td>
          <td><code>FLOKI/USDT</code></td>
          <td class="text-green">0.2%</td>
          <td>10</td>
          <td>$1.00 USDT</td>
          <td class="text-cyan fw700">$20</td>
          <td><span class="tag tag-indigo">micro-cap meme</span></td>
        </tr>
        <tr>
          <td class="fw700">DOGE</td>
          <td><code>DOGE/USDT</code></td>
          <td class="text-yellow">0.3%</td>
          <td>10</td>
          <td>$1.00 USDT</td>
          <td class="text-cyan fw700">$20</td>
          <td><span class="tag tag-green">mid-cap meme</span></td>
        </tr>
        <tr>
          <td class="fw700">WIF</td>
          <td><code>WIF/USDT</code></td>
          <td class="text-yellow">0.3%</td>
          <td>10</td>
          <td>$1.00 USDT</td>
          <td class="text-cyan fw700">$20</td>
          <td><span class="tag tag-green">mid-cap meme</span></td>
        </tr>
        <tr style="background:rgba(99,102,241,0.05);">
          <td colspan="5" class="fw700" style="color:var(--text);">TOTAL</td>
          <td class="fw700" style="color:var(--accent);font-size:1rem;">$120 USDT</td>
          <td></td>
        </tr>
      </tbody>
    </table>
  </div>

  <div style="margin-top:24px;">
    <div class="info-box">
      <h3>ğŸ’¡ FÃ³rmula do Capital Alocado por Coin</h3>
      <p>
        <code>capital_coin = order_size_usdt Ã— grid_levels Ã— 2</code><br/>
        Para todas as coins: <code>$1.00 Ã— 10 Ã— 2 = $20 por coin</code><br/>
        O fator 2 Ã© porque hÃ¡ ordens BUY abaixo <em>e</em> SELL acima do preÃ§o central.
      </p>
    </div>
  </div>

  <div style="margin-top:16px;">
    <p class="text-muted" style="margin-bottom:8px;font-size:0.9rem;">ConfiguraÃ§Ã£o completa em <code>config.py</code> â€” trecho relevante:</p>
    <div class="code-wrap">
      <span class="code-label">config.py â€” SYMBOLS</span>
      <pre>SYMBOLS = [
    # Micro-cap meme coins: spacing 0.2% â€” $1/ordem Ã— 10 nÃ­veis Ã— 2 = $20/coin
    {"symbol": "PEPE/USDT",  "enabled": True, "grid_levels": 10, "grid_spacing_pct": 0.2, "order_size_usdt": 1.0},
    {"symbol": "SHIB/USDT",  "enabled": True, "grid_levels": 10, "grid_spacing_pct": 0.2, "order_size_usdt": 1.0},
    {"symbol": "BONK/USDT",  "enabled": True, "grid_levels": 10, "grid_spacing_pct": 0.2, "order_size_usdt": 1.0},
    {"symbol": "FLOKI/USDT", "enabled": True, "grid_levels": 10, "grid_spacing_pct": 0.2, "order_size_usdt": 1.0},
    # Mid-cap meme coins: spacing 0.3%
    {"symbol": "DOGE/USDT",  "enabled": True, "grid_levels": 10, "grid_spacing_pct": 0.3, "order_size_usdt": 1.0},
    {"symbol": "WIF/USDT",   "enabled": True, "grid_levels": 10, "grid_spacing_pct": 0.3, "order_size_usdt": 1.0},
]</pre>
    </div>
  </div>
</section>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SEÃ‡ÃƒO 4 â€” COMO O GRID FUNCIONA
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<section id="grid" class="animate-on-scroll">
  <div class="section-header">
    <div class="section-icon icon-green">ğŸ”²</div>
    <h2>Como o Grid Funciona</h2>
  </div>

  <div class="grid-viz">
    <pre style="background:transparent;border:none;border-radius:0;padding:0;color:#e2e8f0;font-size:0.8rem;">
  EXEMPLO: PEPE/USDT | PreÃ§o inicial: $0.00001000 | Spacing: 0.2% | 10 nÃ­veis


                    NÃ­vel +10  $0.00001020  SELL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ topo
                    NÃ­vel  +9  $0.00001018  SELL
                    NÃ­vel  +8  $0.00001016  SELL
                    NÃ­vel  +7  $0.00001014  SELL
                    NÃ­vel  +6  $0.00001012  SELL
                    NÃ­vel  +5  $0.00001010  SELL
                    NÃ­vel  +4  $0.00001008  SELL
                    NÃ­vel  +3  $0.00001006  SELL
                    NÃ­vel  +2  $0.00001004  SELL
                    NÃ­vel  +1  $0.00001002  SELL
  â”€â”€â”€â”€ PREÃ‡O ATUAL â”€â”€â”€ $0.00001000 â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• centro
                    NÃ­vel  -1  $0.00000998  BUY
                    NÃ­vel  -2  $0.00000996  BUY
                    NÃ­vel  -3  $0.00000994  BUY
                    NÃ­vel  -4  $0.00000992  BUY
                    NÃ­vel  -5  $0.00000990  BUY
                    NÃ­vel  -6  $0.00000988  BUY
                    NÃ­vel  -7  $0.00000986  BUY
                    NÃ­vel  -8  $0.00000984  BUY
                    NÃ­vel  -9  $0.00000982  BUY
                    NÃ­vel -10  $0.00000980  BUY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ fundo


  SequÃªncia de um trade lucrativo:
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  1. PreÃ§o cai atÃ© NÃ­vel -3 ($0.00000994)
     â†’ BUY executado: compra 1005.03 PEPE por $1.00 + fee $0.001

  2. Bot cria nova SELL no nÃ­vel seguinte acima ($0.00000996)
     â†’ SELL pendente: 1005.03 PEPE @ $0.00000996

  3. PreÃ§o sobe e toca $0.00000996
     â†’ SELL executado: vende 1005.03 PEPE
     â†’ Receita: $1.001 - fee $0.001 = lucro ~$0.001 (0.1% net)

  4. Bot cria nova BUY de volta em $0.00000994
     â†’ Ciclo recomeÃ§a indefinidamente

  Lucro por ciclo completo:
  (grid_spacing_pct - fee_pctÃ—2) Ã— order_size_usdt
  = (0.2% - 0.2%) Ã— $1.00 â‰ˆ $0.00 â†’ leve ganho nas micro-oscilaÃ§Ãµes
  Nota: lucro real vem de mÃºltiplas oscilaÃ§Ãµes dentro da grade
    </pre>
  </div>

  <div style="margin-top:24px;" class="cards-grid">
    <div class="card">
      <div class="card-title">ğŸ“Œ Setup Inicial</div>
      <p>Ao iniciar, o bot busca o preÃ§o atual da coin e cria a grade centrada nesse preÃ§o. Ordens BUY ficam abaixo, SELL ficam acima. O bot faz um price check a cada <strong>10 segundos</strong> (POLL_INTERVAL).</p>
    </div>
    <div class="card">
      <div class="card-title">ğŸ”„ Ciclo PerpÃ©tuo</div>
      <p>ApÃ³s um BUY, uma SELL Ã© criada no nÃ­vel imediatamente acima. ApÃ³s um SELL, uma BUY Ã© criada no nÃ­vel imediatamente abaixo. O grid nunca expira â€” opera enquanto o bot estiver rodando.</p>
    </div>
    <div class="card">
      <div class="card-title">ğŸ’° Lucro Real</div>
      <p>A taxa de trading simulada Ã© <strong>0.1% por lado</strong> (0.2% round-trip). Com spacing de 0.2%, o lucro lÃ­quido por trade Ã© prÃ³ximo de zero â€” o ganho real vem do volume de trades ao longo do tempo e de oscilaÃ§Ãµes maiores.</p>
    </div>
    <div class="card">
      <div class="card-title">ğŸ”’ Capital Isolado</div>
      <p>Cada GridBot tem seu prÃ³prio <code>self.balance</code> e <code>self.coin_holdings</code>. Uma coin perdendo dinheiro <strong>nÃ£o drena</strong> o capital das outras. O total_results no DB agrega todas.</p>
    </div>
  </div>
</section>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SEÃ‡ÃƒO 5 â€” SISTEMA DE RISCO
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<section id="risco" class="animate-on-scroll">
  <div class="section-header">
    <div class="section-icon icon-red">ğŸ›¡ï¸</div>
    <h2>Sistema de Risco</h2>
  </div>

  <p class="text-muted" style="margin-bottom:24px;font-size:0.95rem;">Seis mecanismos independentes protegem cada coin. A maioria Ã© <strong>por coin</strong> â€” uma coin desabilitada nÃ£o afeta as outras. O circuit breaker global Ã© a Ãºnica exceÃ§Ã£o.</p>

  <div class="risk-grid">

    <div class="risk-item">
      <div class="risk-item-header">
        <div class="risk-item-num">1</div>
        <div class="risk-item-title">Strike System (Drawdown)</div>
      </div>
      <p>Monitora o drawdown do pico de saldo de cada coin. Quando ultrapassa o threshold, registra um "strike". ApÃ³s 3 strikes dentro de 30 minutos, a coin Ã© desabilitada. O flag de "em drawdown" Ã© resetado quando a recuperaÃ§Ã£o Ã© suficiente (strikes permanecem no window).</p>
      <div class="risk-value">Threshold: drawdown &gt; 25% do pico</div>
      <div class="risk-value" style="margin-left:8px;">3 strikes / 30 min â†’ disable</div>
      <div class="risk-value" style="margin-left:8px;">Recovery: drawdown &lt; 10%</div>
    </div>

    <div class="risk-item">
      <div class="risk-item-header">
        <div class="risk-item-num">2</div>
        <div class="risk-item-title">Daily Loss Limit</div>
      </div>
      <p>Se a perda bruta da coin no dia corrente ultrapassar o limite, a coin Ã© desabilitada imediatamente â€” sem esperar strikes. Esse check acontece a cada trade via <code>_update_stats()</code>. Medido em USDT absoluto (nÃ£o percentual).</p>
      <div class="risk-value">Limite: perda diÃ¡ria &gt; $10 USDT</div>
      <div class="risk-value" style="margin-left:8px;">AÃ§Ã£o: disable imediato</div>
    </div>

    <div class="risk-item">
      <div class="risk-item-header">
        <div class="risk-item-num">3</div>
        <div class="risk-item-title">Stop-Loss Mode (SuspensÃ£o de BUYs)</div>
      </div>
      <p>Quando o preÃ§o cai mais de 12% abaixo do centro do grid, o bot para de executar ordens BUY mas continua executando SELLs (para liquidar posiÃ§Ãµes abertas). Quando o preÃ§o se recupera (queda &lt; 6% = 50% do threshold), o modo Ã© desativado automaticamente.</p>
      <div class="risk-value">Ativa: queda &gt; 12% do centro</div>
      <div class="risk-value" style="margin-left:8px;">Desativa: queda &lt; 6% (50% recovery)</div>
    </div>

    <div class="risk-item">
      <div class="risk-item-header">
        <div class="risk-item-num">4</div>
        <div class="risk-item-title">Stop-Loss Total (Fechamento ForÃ§ado)</div>
      </div>
      <p>Queda crÃ­tica: se o preÃ§o cair mais de 15% abaixo do centro do grid, o bot fecha todas as posiÃ§Ãµes abertas (SELL imediato a preÃ§o de mercado), registra o P&L no banco, desabilita a coin e notifica via Telegram. Sem possibilidade de auto-recuperaÃ§Ã£o â€” requer intervenÃ§Ã£o manual.</p>
      <div class="risk-value">Ativa: queda &gt; 15% do centro</div>
      <div class="risk-value" style="margin-left:8px;">AÃ§Ã£o: fechar tudo + disable</div>
    </div>

    <div class="risk-item">
      <div class="risk-item-header">
        <div class="risk-item-num">5</div>
        <div class="risk-item-title">Balance Floor</div>
      </div>
      <p>Se o saldo da coin cair abaixo de 60% do capital inicial alocado (i.e., perda acumulada de 40% ou mais), a coin Ã© desabilitada. Isso garante que nunca se perde mais de $8 de um capital inicial de $20 por coin atravÃ©s deste mecanismo.</p>
      <div class="risk-value">Capital inicial: $20 por coin</div>
      <div class="risk-value" style="margin-left:8px;">Floor: perda &gt; 40% ($8) â†’ disable</div>
    </div>

    <div class="risk-item" style="border-left-color:var(--orange);">
      <div class="risk-item-header">
        <div class="risk-item-num" style="background:rgba(249,115,22,0.2);border-color:rgba(249,115,22,0.4);color:var(--orange);">6</div>
        <div class="risk-item-title">Global Circuit Breaker</div>
      </div>
      <p>Flag no banco de dados (<code>bot_state.trading_enabled</code>) que pausa <strong>todo o bot</strong> imediatamente. O processo Python continua rodando (dashboard continua funcionando), mas nenhuma ordem Ã© executada. Pode ser setado manualmente via SQL ou via dashboard.</p>
      <div class="risk-value" style="background:rgba(249,115,22,0.1);border-color:rgba(249,115,22,0.3);color:#fdba74;">Escopo: todo o bot (todas as coins)</div>
      <div class="risk-value" style="margin-left:8px;background:rgba(249,115,22,0.1);border-color:rgba(249,115,22,0.3);color:#fdba74;">Reabilitar: UPDATE bot_state SET trading_enabled=TRUE</div>
    </div>

  </div>

  <div style="margin-top:32px;">
    <h3 style="font-size:1.1rem;font-weight:700;margin-bottom:16px;">ğŸ”§ Como Reabilitar uma Coin Desabilitada</h3>
    <div class="two-col">
      <div>
        <p class="text-muted" style="margin-bottom:8px;font-size:0.88rem;">Via SQL (forma direta):</p>
        <div class="code-wrap">
          <span class="code-label">psql</span>
          <pre>-- Ver coins desabilitadas
SELECT symbol, reason, disabled_at
FROM disabled_symbols
ORDER BY disabled_at DESC;

-- Reabilitar coin especÃ­fica
DELETE FROM disabled_symbols
WHERE symbol = 'PEPE/USDT';

-- Reabilitar circuit breaker global
UPDATE bot_state
SET trading_enabled = TRUE
WHERE id = 1;

-- Reiniciar bot apÃ³s mudanÃ§a
-- (no terminal da VPS)
systemctl --user restart trading-bot</pre>
        </div>
      </div>
      <div>
        <p class="text-muted" style="margin-bottom:8px;font-size:0.88rem;">Via Dashboard (mais fÃ¡cil):</p>
        <div class="success-box" style="margin-bottom:0;">
          <h3>âœ… Dashboard â€” BotÃ£o Reabilitar</h3>
          <p>
            O dashboard em <code>http://138.197.19.184:8766</code> exibe um botÃ£o <strong>"Reabilitar"</strong> ao lado de cada coin desabilitada.<br/><br/>
            Ao clicar, a rota <code>POST /api/resume/&lt;symbol&gt;</code> do Flask executa o <code>DELETE FROM disabled_symbols</code> e reinicia o grid para aquela coin automaticamente.
          </p>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SEÃ‡ÃƒO 6 â€” BANCO DE DADOS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<section id="banco" class="animate-on-scroll">
  <div class="section-header">
    <div class="section-icon icon-purple">ğŸ—„ï¸</div>
    <h2>Banco de Dados</h2>
  </div>

  <div class="info-box" style="margin-bottom:24px;">
    <h3>ğŸ“Œ ConexÃ£o</h3>
    <p>
      <strong>Engine:</strong> PostgreSQL 16 (systemd service do sistema)<br/>
      <strong>URL:</strong> <code>postgresql://andre:u+oVn9kpPEL5MvibJgQgCJj8gHEXAK50@localhost:5432/trading</code><br/>
      <strong>Tabelas criadas automaticamente</strong> pelo <code>ensure_tables()</code> no startup do bot (exceto <code>trades</code> e <code>total_results</code> que devem existir previamente).
    </p>
  </div>

  <div style="display:flex;flex-direction:column;gap:24px;">

    <div>
      <h3 style="font-size:1rem;font-weight:700;margin-bottom:12px;">ğŸ“Š Tabela: <code>trades</code></h3>
      <p class="text-muted" style="margin-bottom:12px;font-size:0.88rem;">Registro de cada trade executado (BUY ou SELL) por todas as coins.</p>
      <div class="code-wrap">
        <span class="code-label">SQL â€” CREATE TABLE trades</span>
        <pre>CREATE TABLE IF NOT EXISTS trades (
    id          SERIAL PRIMARY KEY,
    symbol      VARCHAR(20) DEFAULT 'PEPE/USDT',  -- par negociado
    side        VARCHAR(4)  NOT NULL,               -- 'BUY' ou 'SELL'
    amount      NUMERIC(20,10) NOT NULL,             -- quantidade da coin
    price       NUMERIC(20,10) NOT NULL,             -- preÃ§o de execuÃ§Ã£o
    value_usdt  NUMERIC(16,6),                       -- amount Ã— price
    fee_usdt    NUMERIC(16,8) DEFAULT 0,             -- taxa 0.1% simulada
    profit_usdt NUMERIC(16,8) DEFAULT 0,             -- lucro/prejuÃ­zo (sÃ³ SELLs)
    profit_pct  NUMERIC(10,6) DEFAULT 0,             -- profit_usdt / custo_buy Ã— 100
    mode        VARCHAR(10) DEFAULT 'paper',         -- 'paper' ou 'live'
    grid_level  INT,                                  -- Ã­ndice do nÃ­vel no grid
    created_at  TIMESTAMPTZ DEFAULT NOW()
);</pre>
      </div>
    </div>

    <div>
      <h3 style="font-size:1rem;font-weight:700;margin-bottom:12px;">ğŸ“… Tabela: <code>daily_results</code></h3>
      <p class="text-muted" style="margin-bottom:12px;font-size:0.88rem;">Resultados diÃ¡rios agregados (upsert a cada trade â€” data Ã© chave Ãºnica).</p>
      <div class="code-wrap">
        <span class="code-label">SQL â€” CREATE TABLE daily_results</span>
        <pre>CREATE TABLE IF NOT EXISTS daily_results (
    id               SERIAL PRIMARY KEY,
    date             DATE UNIQUE NOT NULL,         -- chave: YYYY-MM-DD
    total_trades     INT     DEFAULT 0,
    winning_trades   INT     DEFAULT 0,
    losing_trades    INT     DEFAULT 0,
    gross_profit     NUMERIC(14,6) DEFAULT 0,      -- soma dos SELLs lucrativos
    gross_loss       NUMERIC(14,6) DEFAULT 0,      -- soma dos SELLs com prejuÃ­zo (negativo)
    net_profit       NUMERIC(14,6) DEFAULT 0,      -- gross_profit + gross_loss
    win_rate         NUMERIC(6,2)  DEFAULT 0,      -- winning_trades / total Ã— 100
    starting_balance NUMERIC(14,4) DEFAULT 0,      -- saldo no inÃ­cio do dia
    ending_balance   NUMERIC(14,4) DEFAULT 0       -- saldo atual (atualizado a cada trade)
);</pre>
      </div>
    </div>

    <div>
      <h3 style="font-size:1rem;font-weight:700;margin-bottom:12px;">ğŸ“ˆ Tabela: <code>total_results</code></h3>
      <p class="text-muted" style="margin-bottom:12px;font-size:0.88rem;">MÃ©tricas globais acumuladas (sempre 1 linha â€” id=1). Atualizada a cada trade.</p>
      <div class="code-wrap">
        <span class="code-label">SQL â€” CREATE TABLE total_results</span>
        <pre>CREATE TABLE IF NOT EXISTS total_results (
    id               INT PRIMARY KEY DEFAULT 1,
    updated_at       TIMESTAMPTZ DEFAULT NOW(),
    starting_balance NUMERIC(14,4) DEFAULT 120.0,  -- capital inicial total
    current_balance  NUMERIC(14,4) DEFAULT 120.0,  -- saldo atual somado de todas as coins
    net_profit_usdt  NUMERIC(14,6) DEFAULT 0,       -- lucro lÃ­quido total (USDT)
    net_profit_pct   NUMERIC(10,4) DEFAULT 0,       -- (current - starting) / starting Ã— 100
    win_rate         NUMERIC(6,2)  DEFAULT 0,       -- % de trades lucrativos
    total_trades     INT           DEFAULT 0,
    winning_trades   INT           DEFAULT 0,
    peak_balance     NUMERIC(14,4) DEFAULT 120.0,   -- maior saldo atingido
    max_drawdown_pct NUMERIC(10,4) DEFAULT 0        -- maior queda do pico (%)
);

INSERT INTO total_results (id) VALUES (1) ON CONFLICT DO NOTHING;</pre>
      </div>
    </div>

    <div>
      <h3 style="font-size:1rem;font-weight:700;margin-bottom:12px;">ğŸš« Tabela: <code>disabled_symbols</code></h3>
      <p class="text-muted" style="margin-bottom:12px;font-size:0.88rem;">Coins desabilitadas pelo sistema de risco. PresenÃ§a de um registro = coin pausada.</p>
      <div class="code-wrap">
        <span class="code-label">SQL â€” CREATE TABLE disabled_symbols</span>
        <pre>CREATE TABLE IF NOT EXISTS disabled_symbols (
    id          SERIAL PRIMARY KEY,
    symbol      VARCHAR(20)  NOT NULL,   -- ex: 'PEPE/USDT'
    reason      VARCHAR(100),             -- ex: 'drawdown_3x_28pct', 'daily_loss_$3.50'
    daily_pnl   NUMERIC(12,6),           -- P&amp;L do dia no momento do disable
    total_pnl   NUMERIC(12,6),           -- P&amp;L total no momento do disable
    disabled_at TIMESTAMPTZ DEFAULT NOW()
);

-- Para reabilitar: DELETE FROM disabled_symbols WHERE symbol = 'PEPE/USDT';</pre>
      </div>
    </div>

    <div>
      <h3 style="font-size:1rem;font-weight:700;margin-bottom:12px;">â›” Tabela: <code>bot_state</code></h3>
      <p class="text-muted" style="margin-bottom:12px;font-size:0.88rem;">Circuit breaker global. Sempre 1 linha (id=1). Criada pelo <code>ensure_tables()</code>.</p>
      <div class="code-wrap">
        <span class="code-label">SQL â€” CREATE TABLE bot_state</span>
        <pre>CREATE TABLE IF NOT EXISTS bot_state (
    id              INT PRIMARY KEY DEFAULT 1,
    trading_enabled BOOLEAN NOT NULL DEFAULT TRUE,  -- FALSE = bot pausado
    halted_at       TIMESTAMPTZ,                     -- quando foi pausado
    halt_reason     TEXT,                            -- motivo do pause
    halted_coin     VARCHAR(20),                     -- qual coin triggerou (se aplicÃ¡vel)
    resumed_at      TIMESTAMPTZ                      -- quando foi reabilitado
);

INSERT INTO bot_state (id, trading_enabled) VALUES (1, TRUE) ON CONFLICT DO NOTHING;

-- Para pausar tudo:
UPDATE bot_state SET trading_enabled = FALSE WHERE id = 1;
-- Para retomar:
UPDATE bot_state SET trading_enabled = TRUE WHERE id = 1;</pre>
      </div>
    </div>

  </div>
</section>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SEÃ‡ÃƒO 7 â€” CÃ“DIGO FONTE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<section id="codigo" class="animate-on-scroll">
  <div class="section-header">
    <div class="section-icon icon-cyan">ğŸ’»</div>
    <h2>CÃ³digo Fonte</h2>
  </div>

  <p class="text-muted" style="margin-bottom:24px;font-size:0.95rem;">CÃ³digo completo e atual de todos os arquivos principais. Clique em cada arquivo para expandir. Ãšltima versÃ£o sincronizada com o repositÃ³rio no momento da geraÃ§Ã£o deste documento.</p>

  <div class="info-box" style="margin-bottom:24px;">
    <h3>ğŸ“¦ dashboard.py â€” nÃ£o incluÃ­do aqui</h3>
    <p>
      O <code>dashboard.py</code> tem ~600 linhas e estÃ¡ disponÃ­vel no repositÃ³rio GitHub.<br/>
      <strong>Rotas principais:</strong><br/>
      &nbsp;&nbsp;â€¢ <code>GET /</code> â€” Serve o HTML do dashboard (mÃ©tricas, coins, trades recentes, chart 7 dias)<br/>
      &nbsp;&nbsp;â€¢ <code>GET /api/stats</code> â€” Retorna JSON com total_results + disabled_symbols<br/>
      &nbsp;&nbsp;â€¢ <code>GET /api/daily-pnl-by-coin</code> â€” Retorna JSON com P&L diÃ¡rio agrupado por coin<br/>
      &nbsp;&nbsp;â€¢ <code>POST /api/resume/&lt;symbol&gt;</code> â€” Remove da disabled_symbols (reabilita a coin)
    </p>
  </div>

  <!-- requirements.txt -->
  <div class="source-file open" id="sf-requirements">
    <button class="source-trigger" onclick="toggleSource('sf-requirements')">
      <span class="source-trigger-left">
        <span class="file-badge">ğŸ“„ requirements.txt</span>
        <span class="text-muted" style="font-size:0.82rem;font-weight:400;">dependÃªncias Python do bot</span>
      </span>
      <svg class="source-chevron" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
    </button>
    <div class="source-body" style="max-height:500px;">
      <pre>ccxt>=4.0.0
psycopg2-binary>=2.9.0
requests>=2.31.0
# flask e flask-cors instalados separadamente para o dashboard
# pip install flask flask-cors</pre>
    </div>
  </div>

  <!-- config.py -->
  <div class="source-file" id="sf-config">
    <button class="source-trigger" onclick="toggleSource('sf-config')">
      <span class="source-trigger-left">
        <span class="file-badge">ğŸ”§ config.py</span>
        <span class="text-muted" style="font-size:0.82rem;font-weight:400;">toda a configuraÃ§Ã£o â€” coins, risk, DB, API</span>
      </span>
      <svg class="source-chevron" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
    </button>
    <div class="source-body">
      <pre># Trading Bot Configuration
# Switch PAPER_MODE to False and add API keys to go live

PAPER_MODE = True

# Exchange (used for live mode)
EXCHANGE = "okx"
API_KEY = ""       # Fill in when going live
API_SECRET = ""    # Fill in when going live

# â”€â”€ Multi-Coin Configuration â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Each entry: symbol, enabled flag, grid settings, order size
# To manually disable a coin: set "enabled": False
SYMBOLS = [
    # Micro-cap meme coins: spacing 0.2% â€” $1/ordem Ã— 10 nÃ­veis Ã— 2 = $20/coin
    {"symbol": "PEPE/USDT",  "enabled": True, "grid_levels": 10, "grid_spacing_pct": 0.2, "order_size_usdt": 1.0},
    {"symbol": "SHIB/USDT",  "enabled": True, "grid_levels": 10, "grid_spacing_pct": 0.2, "order_size_usdt": 1.0},
    {"symbol": "BONK/USDT",  "enabled": True, "grid_levels": 10, "grid_spacing_pct": 0.2, "order_size_usdt": 1.0},
    {"symbol": "FLOKI/USDT", "enabled": True, "grid_levels": 10, "grid_spacing_pct": 0.2, "order_size_usdt": 1.0},
    # Mid-cap meme coins: spacing 0.3%
    {"symbol": "DOGE/USDT",  "enabled": True, "grid_levels": 10, "grid_spacing_pct": 0.3, "order_size_usdt": 1.0},
    {"symbol": "WIF/USDT",   "enabled": True, "grid_levels": 10, "grid_spacing_pct": 0.3, "order_size_usdt": 1.0},
]

# â”€â”€ Auto-Disable Thresholds â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Coin is disabled automatically if it exceeds these loss thresholds
AUTO_DISABLE_DAILY_LOSS_PCT  = 20.0   # % of capital allocated (order_size * grid_levels * 2)
AUTO_DISABLE_TOTAL_LOSS_PCT  = 30.0   # % of capital allocated (cumulative)

# â”€â”€ Legacy single-symbol fallback (kept for compatibility) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
SYMBOL = SYMBOLS[0]["symbol"]
QUOTE_CURRENCY = "USDT"

# â”€â”€ Shared Grid defaults (used if per-symbol values not present) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
STARTING_BALANCE  = 120.0   # USDT total (6 coins Ã— $20/coin)
GRID_LEVELS       = 10
GRID_SPACING_PCT  = 0.5
ORDER_SIZE_USDT   = 5.0

# â”€â”€ Stop-Loss â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
STOP_LOSS_PCT        = 12.0   # Se preÃ§o cair X% abaixo do centro do grid â†’ para compras
STOP_LOSS_CLOSE_PCT  = 15.0   # Se preÃ§o cair X% â†’ fecha posiÃ§Ãµes e desabilita coin
BALANCE_FLOOR_PCT    = 40.0   # Se saldo cair abaixo de 40% do capital inicial â†’ desabilita

# â”€â”€ Risk management (global) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
MAX_DRAWDOWN_PCT      = 25.0   # Drawdown strike threshold (per-coin, from peak)
DRAWDOWN_MAX_STRIKES  = 3      # Disable coin after this many strikes
DRAWDOWN_STRIKE_WINDOW_MIN = 30  # Strike window in minutes (older strikes don't count)
DRAWDOWN_RECOVERY_PCT = 10.0  # Reset strikes when drawdown drops below this %
DAILY_LOSS_LIMIT_USDT = 10.0  # Disable coin if daily loss > this (per-coin)

# â”€â”€ Notifications â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
TELEGRAM_TARGET  = "7965086167"
TELEGRAM_CHANNEL = "telegram"

# â”€â”€ Database â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
DB_URL = "postgresql://andre:u+oVn9kpPEL5MvibJgQgCJj8gHEXAK50@localhost:5432/trading"

# â”€â”€ Polling interval (seconds) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
POLL_INTERVAL = 10</pre>
    </div>
  </div>

  <!-- exchange.py -->
  <div class="source-file" id="sf-exchange">
    <button class="source-trigger" onclick="toggleSource('sf-exchange')">
      <span class="source-trigger-left">
        <span class="file-badge">ğŸ“¡ exchange.py</span>
        <span class="text-muted" style="font-size:0.82rem;font-weight:400;">price feeds â€” OKX â†’ KuCoin â†’ Gate.io</span>
      </span>
      <svg class="source-chevron" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
    </button>
    <div class="source-body">
      <pre>"""Exchange abstraction â€” paper mode uses real prices, simulates orders."""
import requests
from config import SYMBOL, EXCHANGE, API_KEY, API_SECRET, PAPER_MODE

def get_price(symbol=SYMBOL) -> float:
    """Fetch current price. OKX primary, KuCoin fallback, Gate.io tertiary."""
    base, quote = symbol.split("/")

    # OKX public API (no geo-restrictions)
    try:
        url = f"https://www.okx.com/api/v5/market/ticker?instId={base}-{quote}"
        r = requests.get(url, timeout=5)
        return float(r.json()["data"][0]["last"])
    except Exception as e:
        print(f"[exchange] OKX error: {e}")

    # KuCoin fallback
    try:
        url = f"https://api.kucoin.com/api/v1/market/orderbook/level1?symbol={base}-{quote}"
        r = requests.get(url, timeout=5)
        return float(r.json()["data"]["price"])
    except Exception as e:
        print(f"[exchange] KuCoin error: {e}")

    # Gate.io tertiary
    try:
        url = f"https://api.gateio.ws/api/v4/spot/tickers?currency_pair={base}_{quote}"
        r = requests.get(url, timeout=5)
        return float(r.json()[0]["last"])
    except Exception as e:
        print(f"[exchange] Gate.io error: {e}")
        return None

def get_ccxt_exchange():
    """Return authenticated ccxt exchange (live mode only)."""
    import ccxt
    exchange_class = getattr(ccxt, EXCHANGE)
    return exchange_class({"apiKey": API_KEY, "secret": API_SECRET})</pre>
    </div>
  </div>

  <!-- notifier.py -->
  <div class="source-file" id="sf-notifier">
    <button class="source-trigger" onclick="toggleSource('sf-notifier')">
      <span class="source-trigger-left">
        <span class="file-badge">ğŸ“¢ notifier.py</span>
        <span class="text-muted" style="font-size:0.82rem;font-weight:400;">Telegram via openclaw CLI subprocess</span>
      </span>
      <svg class="source-chevron" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
    </button>
    <div class="source-body">
      <pre>"""Telegram notifications."""
import subprocess
import shutil
from config import TELEGRAM_TARGET, TELEGRAM_CHANNEL

# Resolve openclaw path at import time
OPENCLAW_BIN = shutil.which("openclaw") or "/home/clawdbot/.npm-global/bin/openclaw"

def send(message: str):
    try:
        subprocess.run(
            [OPENCLAW_BIN, "message", "send",
             "--channel", TELEGRAM_CHANNEL,
             "--target", TELEGRAM_TARGET,
             "--message", message],
            check=True, capture_output=True
        )
    except Exception as e:
        print(f"[notifier] error: {e}")</pre>
    </div>
  </div>

  <!-- database.py -->
  <div class="source-file" id="sf-database">
    <button class="source-trigger" onclick="toggleSource('sf-database')">
      <span class="source-trigger-left">
        <span class="file-badge">ğŸ—„ï¸ database.py</span>
        <span class="text-muted" style="font-size:0.82rem;font-weight:400;">PostgreSQL layer â€” CRUD, ensure_tables, circuit breaker</span>
      </span>
      <svg class="source-chevron" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
    </button>
    <div class="source-body">
      <pre>"""PostgreSQL interface for the trading bot."""
import psycopg2
import psycopg2.extras
from datetime import date, datetime, timezone
from config import DB_URL

def get_conn():
    return psycopg2.connect(DB_URL)


def ensure_tables():
    """Create any missing tables (idempotent â€” safe to call on startup)."""
    with get_conn() as conn:
        with conn.cursor() as cur:
            # disabled_symbols table â€” tracks coins auto-disabled by risk limits
            cur.execute("""
                CREATE TABLE IF NOT EXISTS disabled_symbols (
                    id          SERIAL PRIMARY KEY,
                    symbol      VARCHAR(20) NOT NULL,
                    reason      VARCHAR(100),
                    daily_pnl   NUMERIC(12,6),
                    total_pnl   NUMERIC(12,6),
                    disabled_at TIMESTAMPTZ DEFAULT NOW()
                )
            """)
            # Ensure trades table has symbol column (migration safety)
            cur.execute("""
                ALTER TABLE trades ADD COLUMN IF NOT EXISTS symbol VARCHAR(20) DEFAULT 'PEPE/USDT'
            """)
            # bot_state table â€” persistent circuit breaker flag
            cur.execute("""
                CREATE TABLE IF NOT EXISTS bot_state (
                    id              INT PRIMARY KEY DEFAULT 1,
                    trading_enabled BOOLEAN NOT NULL DEFAULT TRUE,
                    halted_at       TIMESTAMPTZ,
                    halt_reason     TEXT,
                    halted_coin     VARCHAR(20),
                    resumed_at      TIMESTAMPTZ
                )
            """)
            # Ensure exactly one row always exists
            cur.execute("""
                INSERT INTO bot_state (id, trading_enabled)
                VALUES (1, TRUE)
                ON CONFLICT (id) DO NOTHING
            """)
        conn.commit()


def is_trading_enabled() -> bool:
    """Check if trading is globally enabled (circuit breaker not tripped)."""
    try:
        with get_conn() as conn:
            with conn.cursor() as cur:
                cur.execute("SELECT trading_enabled FROM bot_state WHERE id = 1")
                row = cur.fetchone()
                return bool(row[0]) if row else True
    except Exception as e:
        print(f"[db] is_trading_enabled error: {e}")
        return True  # fail-open: don't block trading on DB error


def halt_trading(reason: str, coin: str = None):
    """Disable trading globally and record why (circuit breaker)."""
    try:
        with get_conn() as conn:
            with conn.cursor() as cur:
                cur.execute("""
                    UPDATE bot_state SET
                        trading_enabled = FALSE,
                        halted_at       = NOW(),
                        halt_reason     = %s,
                        halted_coin     = %s
                    WHERE id = 1
                """, (reason, coin))
            conn.commit()
        print(f"[db] halt_trading: {reason} (coin={coin})")
    except Exception as e:
        print(f"[db] halt_trading error: {e}")


def resume_trading():
    """Re-enable trading globally (call after operator gives the OK)."""
    try:
        with get_conn() as conn:
            with conn.cursor() as cur:
                cur.execute("""
                    UPDATE bot_state SET
                        trading_enabled = TRUE,
                        resumed_at      = NOW(),
                        halt_reason     = NULL,
                        halted_coin     = NULL
                    WHERE id = 1
                """)
            conn.commit()
        print("[db] resume_trading: trading re-enabled")
    except Exception as e:
        print(f"[db] resume_trading error: {e}")


def log_trade(side, amount, price, fee_usdt=0, profit_usdt=0, profit_pct=0,
              grid_level=None, mode="paper", symbol="PEPE/USDT"):
    value_usdt = float(amount) * float(price)
    with get_conn() as conn:
        with conn.cursor() as cur:
            cur.execute("""
                INSERT INTO trades
                    (symbol, side, amount, price, value_usdt, fee_usdt,
                     profit_usdt, profit_pct, mode, grid_level)
                VALUES (%s, %s, %s, %s, %s, %s, %s, %s, %s, %s)
            """, (symbol, side, amount, price, value_usdt, fee_usdt,
                  profit_usdt, profit_pct, mode, grid_level))
        conn.commit()


def update_total(current_balance, starting_balance, net_profit, win_rate,
                 total_trades, winning_trades, peak_balance, max_drawdown_pct):
    net_profit_pct = ((current_balance - starting_balance) / starting_balance) * 100
    with get_conn() as conn:
        with conn.cursor() as cur:
            cur.execute("""
                UPDATE total_results SET
                    updated_at       = NOW(),
                    current_balance  = %s,
                    net_profit_usdt  = %s,
                    net_profit_pct   = %s,
                    win_rate         = %s,
                    total_trades     = %s,
                    winning_trades   = %s,
                    peak_balance     = %s,
                    max_drawdown_pct = %s
                WHERE id = 1
            """, (current_balance, net_profit, net_profit_pct, win_rate,
                  total_trades, winning_trades, peak_balance, max_drawdown_pct))
        conn.commit()


def upsert_daily(date_val, total_trades, winning_trades, losing_trades,
                 gross_profit, gross_loss, starting_balance, ending_balance):
    net_profit = gross_profit + gross_loss
    win_rate   = (winning_trades / total_trades * 100) if total_trades > 0 else 0
    with get_conn() as conn:
        with conn.cursor() as cur:
            cur.execute("""
                INSERT INTO daily_results
                    (date, total_trades, winning_trades, losing_trades,
                     gross_profit, gross_loss, net_profit, win_rate,
                     starting_balance, ending_balance)
                VALUES (%s, %s, %s, %s, %s, %s, %s, %s, %s, %s)
                ON CONFLICT (date) DO UPDATE SET
                    total_trades     = EXCLUDED.total_trades,
                    winning_trades   = EXCLUDED.winning_trades,
                    losing_trades    = EXCLUDED.losing_trades,
                    gross_profit     = EXCLUDED.gross_profit,
                    gross_loss       = EXCLUDED.gross_loss,
                    net_profit       = EXCLUDED.net_profit,
                    win_rate         = EXCLUDED.win_rate,
                    ending_balance   = EXCLUDED.ending_balance
            """, (date_val, total_trades, winning_trades, losing_trades,
                  gross_profit, gross_loss, net_profit, win_rate,
                  starting_balance, ending_balance))
        conn.commit()


def load_state() -> dict:
    """Load persisted bot state from total_results. Returns defaults if empty."""
    try:
        with get_conn() as conn:
            with conn.cursor() as cur:
                cur.execute("""
                    SELECT current_balance, starting_balance, peak_balance,
                           net_profit_usdt, total_trades, winning_trades, max_drawdown_pct
                    FROM total_results WHERE id=1
                """)
                row = cur.fetchone()
                if row:
                    keys = ["current_balance", "starting_balance", "peak_balance",
                            "net_profit_usdt", "total_trades", "winning_trades",
                            "max_drawdown_pct"]
                    return dict(zip(keys,
                                   [float(v) if v is not None else 0.0 for v in row]))
    except Exception as e:
        print(f"[db] load_state error: {e}")
    return {}


# â”€â”€ Per-symbol P&amp;L helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

def get_symbol_daily_pnl(symbol: str) -> float:
    """Return today's net P&amp;L (USDT) for a specific symbol."""
    try:
        with get_conn() as conn:
            with conn.cursor() as cur:
                cur.execute("""
                    SELECT COALESCE(SUM(profit_usdt), 0.0)
                    FROM trades
                    WHERE symbol = %s
                      AND DATE(created_at AT TIME ZONE 'UTC') = CURRENT_DATE
                """, (symbol,))
                row = cur.fetchone()
                return float(row[0]) if row else 0.0
    except Exception as e:
        print(f"[db] get_symbol_daily_pnl error ({symbol}): {e}")
        return 0.0


def get_symbol_total_pnl(symbol: str) -> float:
    """Return cumulative net P&amp;L (USDT) for a specific symbol (all time)."""
    try:
        with get_conn() as conn:
            with conn.cursor() as cur:
                cur.execute("""
                    SELECT COALESCE(SUM(profit_usdt), 0.0)
                    FROM trades
                    WHERE symbol = %s
                """, (symbol,))
                row = cur.fetchone()
                return float(row[0]) if row else 0.0
    except Exception as e:
        print(f"[db] get_symbol_total_pnl error ({symbol}): {e}")
        return 0.0


def disable_symbol(symbol: str, reason: str = "manual",
                   daily_pnl: float = 0.0, total_pnl: float = 0.0):
    """Record that a symbol was disabled (auto or manual)."""
    try:
        with get_conn() as conn:
            with conn.cursor() as cur:
                cur.execute("""
                    INSERT INTO disabled_symbols (symbol, reason, daily_pnl, total_pnl)
                    VALUES (%s, %s, %s, %s)
                """, (symbol, reason, daily_pnl, total_pnl))
            conn.commit()
        print(f"[db] disabled_symbols: {symbol} ({reason})")
    except Exception as e:
        print(f"[db] disable_symbol error ({symbol}): {e}")


def get_disabled_symbols() -> list:
    """Return list of currently disabled symbols (most recent entry per symbol)."""
    try:
        with get_conn() as conn:
            with conn.cursor(cursor_factory=psycopg2.extras.RealDictCursor) as cur:
                cur.execute("""
                    SELECT DISTINCT ON (symbol)
                           symbol, reason, daily_pnl, total_pnl, disabled_at
                    FROM disabled_symbols
                    ORDER BY symbol, disabled_at DESC
                """)
                return [dict(r) for r in cur.fetchall()]
    except Exception as e:
        print(f"[db] get_disabled_symbols error: {e}")
        return []</pre>
    </div>
  </div>

  <!-- strategy.py -->
  <div class="source-file" id="sf-strategy">
    <button class="source-trigger" onclick="toggleSource('sf-strategy')">
      <span class="source-trigger-left">
        <span class="file-badge">â™Ÿï¸ strategy.py</span>
        <span class="text-muted" style="font-size:0.82rem;font-weight:400;">GridBot class â€” toda a lÃ³gica de grid + sistema de risco</span>
      </span>
      <svg class="source-chevron" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
    </button>
    <div class="source-body">
      <pre>"""Grid trading strategy â€” multi-symbol capable."""
import time
from datetime import date, datetime, timezone
from config import (
    STARTING_BALANCE, MAX_DRAWDOWN_PCT, DAILY_LOSS_LIMIT_USDT, PAPER_MODE,
    DRAWDOWN_MAX_STRIKES, DRAWDOWN_STRIKE_WINDOW_MIN, DRAWDOWN_RECOVERY_PCT,
    STOP_LOSS_PCT, STOP_LOSS_CLOSE_PCT, BALANCE_FLOOR_PCT
)
from exchange import get_price
from database import log_trade, update_total, upsert_daily, disable_symbol
import notifier


class GridBot:
    """Grid bot for a single symbol.  Instantiate one per active coin."""

    def __init__(self, symbol_cfg: dict):
        """
        symbol_cfg keys:
            symbol          str   e.g. "PEPE/USDT"
            grid_levels     int
            grid_spacing_pct float
            order_size_usdt  float
        """
        self.symbol          = symbol_cfg["symbol"]
        self.grid_levels     = symbol_cfg.get("grid_levels", 10)
        self.grid_spacing_pct= symbol_cfg.get("grid_spacing_pct", 0.5)
        self.order_size_usdt = symbol_cfg.get("order_size_usdt", 5.0)

        # Persisted state â€” each bot instance has its own balance bucket
        from database import load_state
        state = load_state()
        # Use a per-symbol portion of the starting balance
        self.balance          = self.order_size_usdt * self.grid_levels * 2  # allocated capital
        self.starting_balance = self.balance
        self.peak_balance     = self.balance
        self.net_profit       = 0.0
        self.total_trades     = 0
        self.winning_trades   = 0
        self.max_drawdown_pct = 0.0
        self.coin_holdings    = 0.0
        self.grid_orders      = {}
        self.day_trades       = 0
        self.day_gross_profit = 0.0
        self.day_gross_loss   = 0.0
        self.day_starting_balance = self.balance
        self.current_day      = date.today()
        self.running          = True
        self.center_price     = None
        self.grid_prices      = []
        # Strike system â€” tracks drawdown events to avoid disabling on single spike
        self._strike_times: list = []   # timestamps (float) of each strike
        self._in_drawdown   = False     # True while currently above threshold
        # Stop-loss state
        self.stop_loss_triggered = False  # True quando preÃ§o caiu demais

    # â”€â”€ Grid setup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    def setup_grid(self, center_price: float):
        """Initialize grid lines around current price."""
        self.center_price = center_price
        self.grid_prices  = []
        for i in range(-self.grid_levels, self.grid_levels + 1):
            price = center_price * (1 + i * self.grid_spacing_pct / 100)
            self.grid_prices.append(round(price, 10))
        self.grid_prices.sort()

        for i, price in enumerate(self.grid_prices):
            if price &lt; center_price:
                amount = self.order_size_usdt / price
                self.grid_orders[i] = {
                    "side": "BUY", "price": price,
                    "amount": amount, "filled": False
                }
            elif price &gt; center_price:
                amount = self.order_size_usdt / center_price
                self.grid_orders[i] = {
                    "side": "SELL", "price": price,
                    "amount": amount, "filled": False
                }

        base = self.symbol.split("/")[0]
        print(f"[grid:{base}] Setup {len(self.grid_orders)} orders @ {center_price:.10g}")

    # â”€â”€ Tick â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    def check_fills(self, current_price: float):
        """Check and simulate order fills at current price."""
        # â”€â”€ Stop-loss check â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        if self.center_price:
            drop_pct = (self.center_price - current_price) / self.center_price * 100

            if drop_pct &gt;= STOP_LOSS_CLOSE_PCT and not self.stop_loss_triggered:
                # Queda crÃ­tica â€” fechar tudo e desabilitar
                self._trigger_stop_loss(current_price, drop_pct)
                return

            if drop_pct &gt;= STOP_LOSS_PCT:
                # Modo de proteÃ§Ã£o â€” nÃ£o comprar mais, sÃ³ vender
                if not self.stop_loss_triggered:
                    self.stop_loss_triggered = True
                    base = self.symbol.split("/")[0]
                    print(f"[grid:{base}] âš ï¸  Stop-loss mode â€” queda {drop_pct:.1f}% do centro, suspendendo BUYs")
                    notifier.send(
                        f"âš ï¸ Stop-loss ativado â€” {self.symbol}\n"
                        f"Queda de {drop_pct:.1f}% do centro do grid ({STOP_LOSS_PCT}% limite)\n"
                        f"Modo proteÃ§Ã£o: apenas SELLs atÃ© recuperaÃ§Ã£o."
                    )
            elif drop_pct &lt; STOP_LOSS_PCT * 0.5 and self.stop_loss_triggered:
                # PreÃ§o se recuperou â€” resetar stop loss
                self.stop_loss_triggered = False
                base = self.symbol.split("/")[0]
                print(f"[grid:{base}] âœ… Stop-loss resetado â€” preÃ§o se recuperou (drop={drop_pct:.1f}%)")
                notifier.send(
                    f"âœ… Stop-loss resetado â€” {self.symbol}\n"
                    f"PreÃ§o se recuperou (queda atual: {drop_pct:.1f}%)\n"
                    f"Retomando compras normalmente."
                )

        # â”€â”€ Processar orders â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        for level, order in list(self.grid_orders.items()):
            if order["filled"]:
                continue
            # Em stop-loss mode: ignora BUYs, sÃ³ executa SELLs
            if self.stop_loss_triggered and order["side"] == "BUY":
                continue
            if order["side"] == "BUY" and current_price &lt;= order["price"]:
                self._fill_buy(level, order, current_price)
            elif order["side"] == "SELL" and current_price &gt;= order["price"]:
                self._fill_sell(level, order, current_price)

    # â”€â”€ Stop-loss trigger â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    def _trigger_stop_loss(self, current_price: float, drop_pct: float):
        """Fechar todas as posiÃ§Ãµes abertas e desabilitar a coin."""
        self.stop_loss_triggered = True

        # Fechar todas as posiÃ§Ãµes compradas (BUYs filled â†’ SELL pendente)
        total_loss = 0.0
        positions_closed = 0
        for level, order in list(self.grid_orders.items()):
            if order["side"] == "SELL" and not order["filled"]:
                # HÃ¡ uma posiÃ§Ã£o comprada aguardando SELL
                buy_price = order.get("buy_price", self.center_price)
                if buy_price:
                    loss = order["amount"] * (current_price - buy_price)
                    fee  = order["amount"] * current_price * 0.001
                    total_loss        += loss - fee
                    self.balance      += order["amount"] * current_price - fee
                    self.coin_holdings -= order["amount"]
                    positions_closed  += 1

        if positions_closed &gt; 0:
            self.net_profit += total_loss
            log_trade("SELL", 0, current_price,
                      fee_usdt=0, profit_usdt=total_loss,
                      profit_pct=drop_pct * -1,
                      grid_level=-1,
                      mode="paper" if PAPER_MODE else "live",
                      symbol=self.symbol)

        disable_symbol(
            self.symbol,
            reason=f"stop_loss_{drop_pct:.0f}pct_drop",
            daily_pnl=self.day_gross_profit + self.day_gross_loss,
            total_pnl=self.net_profit
        )
        notifier.send(
            f"ğŸ›‘ STOP-LOSS â€” {self.symbol}\n"
            f"Queda de {drop_pct:.1f}% do centro do grid\n"
            f"PosiÃ§Ãµes fechadas: {positions_closed}\n"
            f"P&amp;L desta aÃ§Ã£o: ${total_loss:.2f}\n"
            f"Saldo: ${self.balance:.2f} | Lucro total: ${self.net_profit:.2f}\n\n"
            f"Coin desabilitada. Use o botÃ£o no dashboard para reabilitar."
        )
        base = self.symbol.split("/")[0]
        print(f"[grid:{base}] ğŸ›‘ STOP-LOSS triggered â€” {drop_pct:.1f}% drop, "
              f"{positions_closed} positions closed, P&amp;L: ${total_loss:.2f}")
        self.running = False

    # â”€â”€ Fill helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    def _fill_buy(self, level, order, price):
        cost = order["amount"] * price
        fee  = cost * 0.001
        if self.balance &lt; cost + fee:
            return
        self.balance      -= (cost + fee)
        self.coin_holdings += order["amount"]
        self.total_trades  += 1
        self.day_trades    += 1
        order["filled"]     = True

        log_trade("BUY", order["amount"], price,
                  fee_usdt=fee, grid_level=level,
                  mode="paper" if PAPER_MODE else "live",
                  symbol=self.symbol)

        next_price = price * (1 + self.grid_spacing_pct / 100)
        self.grid_orders[level] = {
            "side": "SELL", "price": next_price,
            "amount": order["amount"], "filled": False,
            "buy_price": price
        }
        self._update_stats()
        base = self.symbol.split("/")[0]
        print(f"[grid:{base}] BUY  {order['amount']:.2f} @ {price:.10g} | "
              f"Balance: ${self.balance:.2f}")

    def _fill_sell(self, level, order, price):
        buy_price  = order.get("buy_price", self.center_price)
        profit     = order["amount"] * (price - buy_price)
        fee        = order["amount"] * price * 0.001
        profit    -= fee
        self.balance      += order["amount"] * price - fee
        self.coin_holdings -= order["amount"]
        self.total_trades  += 1
        self.day_trades    += 1
        order["filled"]     = True

        if profit &gt; 0:
            self.winning_trades   += 1
            self.day_gross_profit += profit
        else:
            self.day_gross_loss   += profit
        self.net_profit += profit

        profit_pct = (profit / (order["amount"] * buy_price)) * 100 if buy_price else 0
        log_trade("SELL", order["amount"], price,
                  fee_usdt=fee, profit_usdt=profit, profit_pct=profit_pct,
                  grid_level=level,
                  mode="paper" if PAPER_MODE else "live",
                  symbol=self.symbol)

        next_price = price * (1 - self.grid_spacing_pct / 100)
        self.grid_orders[level] = {
            "side": "BUY", "price": next_price,
            "amount": order["amount"], "filled": False
        }
        self._update_stats()
        base = self.symbol.split("/")[0]
        print(f"[grid:{base}] SELL {order['amount']:.2f} @ {price:.10g} | "
              f"Profit: ${profit:.4f} | Balance: ${self.balance:.2f}")

    # â”€â”€ Stats helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    def _win_rate(self):
        return (self.winning_trades / self.total_trades * 100) \
               if self.total_trades &gt; 0 else 0

    def _update_stats(self):
        if self.balance &gt; self.peak_balance:
            self.peak_balance = self.balance
        drawdown = ((self.peak_balance - self.balance) / self.peak_balance) * 100
        self.max_drawdown_pct = max(self.max_drawdown_pct, drawdown)

        update_total(self.balance, self.starting_balance, self.net_profit,
                     self._win_rate(), self.total_trades, self.winning_trades,
                     self.peak_balance, self.max_drawdown_pct)

        today = date.today()
        if today != self.current_day:
            upsert_daily(self.current_day, self.day_trades, self.winning_trades,
                         self.day_trades - self.winning_trades,
                         self.day_gross_profit, self.day_gross_loss,
                         self.day_starting_balance, self.balance)
            self.current_day          = today
            self.day_trades           = 0
            self.day_gross_profit     = 0.0
            self.day_gross_loss       = 0.0
            self.day_starting_balance = self.balance
        else:
            upsert_daily(self.current_day, self.day_trades, self.winning_trades,
                         self.day_trades - self.winning_trades,
                         self.day_gross_profit, self.day_gross_loss,
                         self.day_starting_balance, self.balance)

        # â”€â”€ Strike system: drawdown per-coin â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        now = time.time()
        window_secs = DRAWDOWN_STRIKE_WINDOW_MIN * 60

        if drawdown &gt;= MAX_DRAWDOWN_PCT:
            if not self._in_drawdown:
                # New strike â€” entering drawdown territory
                self._in_drawdown = True
                # Prune strikes older than the window
                self._strike_times = [t for t in self._strike_times
                                      if now - t &lt; window_secs]
                self._strike_times.append(now)
                strike_count = len(self._strike_times)

                if strike_count &gt;= DRAWDOWN_MAX_STRIKES:
                    # Too many strikes in the window â€” disable this coin
                    disable_symbol(
                        self.symbol,
                        reason=f"drawdown_{strike_count}x_{drawdown:.0f}pct",
                        daily_pnl=self.day_gross_profit + self.day_gross_loss,
                        total_pnl=self.net_profit
                    )
                    notifier.send(
                        f"â›” {self.symbol} DESABILITADA â€” {strike_count}Âº strike\n"
                        f"Drawdown: {drawdown:.1f}% atingido {strike_count}x "
                        f"em {DRAWDOWN_STRIKE_WINDOW_MIN} min\n"
                        f"Saldo: ${self.balance:.2f} | Lucro: ${self.net_profit:.2f}\n"
                        f"Use o botÃ£o Reabilitar no dashboard quando quiser retomar."
                    )
                    self.running = False
                else:
                    # Warning strike â€” keep running
                    notifier.send(
                        f"âš ï¸ {self.symbol} â€” Strike {strike_count}/{DRAWDOWN_MAX_STRIKES}\n"
                        f"Drawdown: {drawdown:.1f}% (limite: {MAX_DRAWDOWN_PCT}%)\n"
                        f"Saldo: ${self.balance:.2f} | Lucro total: ${self.net_profit:.2f}\n"
                        f"Continuando... desabilitarÃ¡ no {DRAWDOWN_MAX_STRIKES}Âº strike."
                    )
        elif drawdown &lt; DRAWDOWN_RECOVERY_PCT and self._in_drawdown:
            # Price recovered â€” reset drawdown flag (strikes remain for window)
            self._in_drawdown = False

        # â”€â”€ Daily loss limit (disable immediately â€” no strikes) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        daily_loss = self.day_gross_loss
        if daily_loss &lt;= -DAILY_LOSS_LIMIT_USDT:
            disable_symbol(
                self.symbol,
                reason=f"daily_loss_${abs(daily_loss):.2f}",
                daily_pnl=self.day_gross_profit + self.day_gross_loss,
                total_pnl=self.net_profit
            )
            notifier.send(
                f"â›” {self.symbol} DESABILITADA â€” Perda diÃ¡ria\n"
                f"Perda hoje: ${abs(daily_loss):.2f} (limite: ${DAILY_LOSS_LIMIT_USDT})\n"
                f"Lucro total: ${self.net_profit:.2f}\n"
                f"As outras coins continuam. ReabilitÃ¡vel pelo dashboard."
            )
            self.running = False

        # â”€â”€ Balance floor â€” nunca perder mais que X% do capital alocado â”€â”€â”€â”€â”€â”€â”€
        if self.starting_balance &gt; 0 and not self.stop_loss_triggered:
            balance_loss_pct = (self.starting_balance - self.balance) / self.starting_balance * 100
            if balance_loss_pct &gt;= BALANCE_FLOOR_PCT:
                floor_usdt = self.starting_balance * (1 - BALANCE_FLOOR_PCT / 100)
                disable_symbol(
                    self.symbol,
                    reason=f"balance_floor_{balance_loss_pct:.0f}pct_loss",
                    daily_pnl=self.day_gross_profit + self.day_gross_loss,
                    total_pnl=self.net_profit
                )
                notifier.send(
                    f"ğŸ›‘ FLOOR DE CAPITAL â€” {self.symbol}\n"
                    f"Perda de {balance_loss_pct:.1f}% do capital inicial\n"
                    f"Saldo: ${self.balance:.2f} (mÃ­nimo: ${floor_usdt:.2f})\n"
                    f"Coin desabilitada. Use o botÃ£o no dashboard para reabilitar."
                )
                base = self.symbol.split("/")[0]
                print(f"[grid:{base}] ğŸ›‘ BALANCE FLOOR triggered â€” {balance_loss_pct:.1f}% loss "
                      f"(floor: ${floor_usdt:.2f})")
                self.running = False</pre>
    </div>
  </div>

  <!-- bot.py -->
  <div class="source-file" id="sf-bot">
    <button class="source-trigger" onclick="toggleSource('sf-bot')">
      <span class="source-trigger-left">
        <span class="file-badge">ğŸš€ bot.py</span>
        <span class="text-muted" style="font-size:0.82rem;font-weight:400;">main loop multi-coin + circuit breaker global</span>
      </span>
      <svg class="source-chevron" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
    </button>
    <div class="source-body">
      <pre>"""Main bot loop â€” multi-coin grid trading with persistent circuit breaker."""
import time
import signal
import sys
from config import (
    PAPER_MODE, SYMBOLS, POLL_INTERVAL,
    AUTO_DISABLE_DAILY_LOSS_PCT, AUTO_DISABLE_TOTAL_LOSS_PCT
)
from exchange import get_price
from strategy import GridBot
from database import (
    ensure_tables, get_symbol_daily_pnl, get_symbol_total_pnl,
    disable_symbol, is_trading_enabled
)
import notifier


# â”€â”€ Startup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

ensure_tables()

# Build active bots from config (only enabled symbols)
active_configs = [cfg for cfg in SYMBOLS if cfg.get("enabled", True)]
bots: dict[str, GridBot] = {}   # symbol -> GridBot instance

print(f"[bot] Starting {'PAPER' if PAPER_MODE else 'LIVE'} trading â€” "
      f"{len(active_configs)} coins: {[c['symbol'] for c in active_configs]}")


# â”€â”€ Signal handlers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

def handle_stop(sig, frame):
    total_profit = sum(b.net_profit for b in bots.values())
    total_trades = sum(b.total_trades for b in bots.values())
    symbols_str  = ", ".join(bots.keys())
    print(f"\n[bot] Stopping all botsâ€¦")
    notifier.send(
        f"â¹ï¸ Multi-coin bot parado manualmente.\n"
        f"Coins: {symbols_str}\n"
        f"Trades totais: {total_trades} | Lucro total: ${total_profit:.4f}"
    )
    sys.exit(0)

signal.signal(signal.SIGTERM, handle_stop)
signal.signal(signal.SIGINT,  handle_stop)


# â”€â”€ Per-symbol auto-disable check â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

def check_auto_disable(symbol: str, bot: GridBot) -&gt; bool:
    """
    Returns True if the symbol should be disabled (and handles notification).
    Uses the per-symbol capital allocation as the reference.
    """
    capital = bot.starting_balance  # allocated capital for this coin

    daily_pnl = get_symbol_daily_pnl(symbol)
    total_pnl = get_symbol_total_pnl(symbol)

    daily_loss_pct = (daily_pnl / capital * 100) if capital &gt; 0 else 0
    total_loss_pct = (total_pnl / capital * 100) if capital &gt; 0 else 0

    reason = None
    if daily_loss_pct &lt;= -AUTO_DISABLE_DAILY_LOSS_PCT:
        reason = "daily_loss_exceeded"
        threshold = AUTO_DISABLE_DAILY_LOSS_PCT
        loss_label = f"Perda diÃ¡ria de {daily_loss_pct:.1f}% ultrapassou limite de -{threshold:.0f}%"
    elif total_loss_pct &lt;= -AUTO_DISABLE_TOTAL_LOSS_PCT:
        reason = "total_loss_exceeded"
        threshold = AUTO_DISABLE_TOTAL_LOSS_PCT
        loss_label = f"Perda total de {total_loss_pct:.1f}% ultrapassou limite de -{threshold:.0f}%"

    if reason:
        disable_symbol(symbol, reason=reason,
                       daily_pnl=daily_pnl, total_pnl=total_pnl)
        notifier.send(
            f"âš ï¸ [TRADING BOT] {symbol} desabilitada automaticamente!\n"
            f"Motivo: {loss_label}\n"
            f"P&amp;L hoje: ${daily_pnl:.2f} | P&amp;L total: ${total_pnl:.2f}"
        )
        print(f"[bot] AUTO-DISABLED {symbol}: {reason}")
        return True

    return False


# â”€â”€ Grid initialisation helper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

def init_bots():
    """Initialise GridBot instances for all active configs."""
    result: dict[str, GridBot] = {}
    for cfg in active_configs:
        sym = cfg["symbol"]
        print(f"[bot] Initialising {sym}â€¦")
        while True:
            price = get_price(sym)
            if price:
                bot = GridBot(cfg)
                bot.setup_grid(price)
                result[sym] = bot
                break
            time.sleep(5)
    return result


# â”€â”€ Main loop â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

def main():
    global bots

    # Check persistent circuit breaker before initialising grids
    if not is_trading_enabled():
        print("[bot] Trading is globally HALTED (circuit breaker active). "
              "Waiting in paused modeâ€¦")
        notifier.send(
            "â¸ï¸ Bot iniciou em modo PAUSADO (circuit breaker ativo no banco).\n"
            "Para retomar: UPDATE bot_state SET trading_enabled=TRUE WHERE id=1;"
        )
    else:
        bots = init_bots()
        notifier.send(
            f"ğŸš€ Multi-coin grid bot iniciado!\n"
            f"Modo: {'ğŸ“„ PAPER' if PAPER_MODE else 'ğŸ’° LIVE'}\n"
            f"Coins activas: {len(bots)}\n"
            + "\n".join(f"  â€¢ {s}" for s in bots)
        )

    # Main tick loop â€” process ALWAYS stays alive
    while True:
        # â”€â”€ Check persistent circuit breaker â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        if not is_trading_enabled():
            time.sleep(POLL_INTERVAL)
            continue

        # â”€â”€ Re-initialise grids if bots dict is empty (after resume) â”€â”€â”€â”€â”€â”€â”€â”€â”€
        if not bots:
            print("[bot] Re-initialising grids after resumeâ€¦")
            bots = init_bots()
            notifier.send(f"â–¶ï¸ Bot retomado! {len(bots)} coins reinicializadas.")

        # â”€â”€ Per-coin loop â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        disabled_this_tick = []

        for symbol, bot in list(bots.items()):
            if not bot.running:
                print(f"[bot] {symbol}: disabled by circuit breaker, removing from active set.")
                disabled_this_tick.append(symbol)
                continue

            # Per-symbol auto-disable check
            if check_auto_disable(symbol, bot):
                disabled_this_tick.append(symbol)
                continue

            # Tick
            price = get_price(symbol)
            if price:
                bot.check_fills(price)

        # Remove disabled bots from active map
        for sym in disabled_this_tick:
            bots.pop(sym, None)

        if not bots:
            print("[bot] No active symbols left. All coins disabled. Dashboard still running.")

        time.sleep(POLL_INTERVAL)


if __name__ == "__main__":
    main()</pre>
    </div>
  </div>

</section>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SEÃ‡ÃƒO 8 â€” SYSTEMD SERVICES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<section id="systemd" class="animate-on-scroll">
  <div class="section-header">
    <div class="section-icon icon-orange">âš™ï¸</div>
    <h2>Systemd Services</h2>
  </div>

  <p class="text-muted" style="margin-bottom:24px;font-size:0.95rem;">Dois serviÃ§os systemd de usuÃ¡rio (<code>--user</code>), rodando como o usuÃ¡rio <code>clawdbot</code>. SÃ£o reiniciados automaticamente pelo sistema operacional em caso de crash.</p>

  <div class="two-col" style="margin-bottom:24px;">
    <div>
      <p class="text-muted" style="margin-bottom:8px;font-size:0.88rem;"><code>/home/clawdbot/.config/systemd/user/trading-bot.service</code></p>
      <div class="code-wrap">
        <span class="code-label">trading-bot.service</span>
        <pre>[Unit]
Description=Crypto Grid Trading Bot (Multi-Coin, Paper Mode)
After=network.target postgresql.service

[Service]
Environment=PATH=/home/clawdbot/.npm-global/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
WorkingDirectory=/home/clawdbot/workspace/coding/trading-bot
ExecStart=/home/clawdbot/.openclaw/workspace/venv/bin/python3 \
    /home/clawdbot/workspace/coding/trading-bot/bot.py
Environment=PYTHONUNBUFFERED=1
Restart=on-failure
RestartSec=30
StandardOutput=append:/home/clawdbot/workspace/coding/trading-bot/bot.log
StandardError=append:/home/clawdbot/workspace/coding/trading-bot/bot.log

[Install]
WantedBy=default.target</pre>
      </div>
    </div>
    <div>
      <p class="text-muted" style="margin-bottom:8px;font-size:0.88rem;"><code>/home/clawdbot/.config/systemd/user/trading-dashboard.service</code></p>
      <div class="code-wrap">
        <span class="code-label">trading-dashboard.service</span>
        <pre>[Unit]
Description=Trading Bot Dashboard (Flask, porta 8766)
After=network.target

[Service]
WorkingDirectory=/home/clawdbot/workspace/coding/trading-bot
ExecStart=/home/linuxbrew/.linuxbrew/bin/python3 \
    /home/clawdbot/workspace/coding/trading-bot/dashboard.py
Restart=always
RestartSec=5
StandardOutput=append:/home/clawdbot/workspace/coding/trading-bot/dashboard.log
StandardError=append:/home/clawdbot/workspace/coding/trading-bot/dashboard.log

[Install]
WantedBy=default.target</pre>
      </div>
    </div>
  </div>

  <h3 style="font-size:1rem;font-weight:700;margin-bottom:12px;">ğŸ”§ Comandos de GestÃ£o</h3>
  <div class="code-wrap">
    <span class="code-label">bash â€” gestÃ£o dos services</span>
    <pre># Ver status dos dois serviÃ§os
systemctl --user status trading-bot trading-dashboard

# Iniciar
systemctl --user start trading-bot trading-dashboard

# Parar
systemctl --user stop trading-bot trading-dashboard

# Reiniciar (apÃ³s mudanÃ§as no cÃ³digo)
systemctl --user restart trading-bot
systemctl --user restart trading-dashboard

# Habilitar no boot
systemctl --user enable trading-bot trading-dashboard

# Recarregar unit files (apÃ³s editar os .service)
systemctl --user daemon-reload

# Ver logs em tempo real
journalctl --user -u trading-bot -f
journalctl --user -u trading-dashboard -f</pre>
  </div>

  <div class="warning-box" style="margin-top:16px;">
    <h3>âš ï¸ PATH no trading-bot.service</h3>
    <p>O <code>notifier.py</code> usa <code>subprocess</code> para chamar o binÃ¡rio <code>openclaw</code>. O PATH da linha <code>Environment=PATH=...</code> no service file Ã© essencial para que o <code>shutil.which("openclaw")</code> resolva para <code>/home/clawdbot/.npm-global/bin/openclaw</code>. Sem isso, as notificaÃ§Ãµes Telegram falham silenciosamente.</p>
  </div>
</section>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SEÃ‡ÃƒO 9 â€” DASHBOARD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<section id="dashboard" class="animate-on-scroll">
  <div class="section-header">
    <div class="section-icon icon-pink">ğŸ“Š</div>
    <h2>Dashboard</h2>
  </div>

  <div class="info-box" style="margin-bottom:24px;">
    <h3>ğŸŒ URL do Dashboard</h3>
    <p>
      <a href="http://138.197.19.184:8766" target="_blank" style="color:#a5b4fc;">http://138.197.19.184:8766</a><br/>
      Flask rodando na porta 8766, servido pelo <code>trading-dashboard.service</code>.<br/>
      Acesso pÃºblico (sem autenticaÃ§Ã£o). Dashboard atualiza automaticamente a cada 30s via JavaScript.
    </p>
  </div>

  <div class="cards-grid">
    <div class="card">
      <div class="card-title">ğŸ“ˆ MÃ©tricas Globais</div>
      <p>Painel principal com: saldo atual, lucro lÃ­quido (USDT e %), win rate, total de trades, peak balance e max drawdown. Dados vindos de <code>/api/stats</code> â†’ <code>total_results</code>.</p>
    </div>
    <div class="card">
      <div class="card-title">ğŸª™ Tabela de Coins</div>
      <p>Status de cada coin (ativa / desabilitada), P&L do dia, P&L total, nÃºmero de trades. Coins desabilitadas mostram o motivo e o botÃ£o <strong>"Reabilitar"</strong>.</p>
    </div>
    <div class="card">
      <div class="card-title">ğŸ“‹ Trades Recentes</div>
      <p>Tabela paginada com os Ãºltimos trades de todas as coins. Colunas: timestamp, sÃ­mbolo, side (BUY/SELL), amount, price, profit USDT, profit %, mode, grid level.</p>
    </div>
    <div class="card">
      <div class="card-title">ğŸ“‰ Chart 7 Dias</div>
      <p>GrÃ¡fico de linha com o P&L diÃ¡rio por coin nos Ãºltimos 7 dias. Dados de <code>/api/daily-pnl-by-coin</code> â†’ agrega tabela <code>trades</code> por data e sÃ­mbolo.</p>
    </div>
  </div>

  <h3 style="font-size:1rem;font-weight:700;margin:24px 0 12px;">ğŸ”Œ Rotas da API Flask</h3>
  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>MÃ©todo</th>
          <th>Rota</th>
          <th>Retorno</th>
          <th>DescriÃ§Ã£o</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><span class="tag tag-indigo">GET</span></td>
          <td><code>/</code></td>
          <td>HTML</td>
          <td>Serve o dashboard completo (HTML + CSS + JS embutidos)</td>
        </tr>
        <tr>
          <td><span class="tag tag-indigo">GET</span></td>
          <td><code>/api/stats</code></td>
          <td>JSON</td>
          <td>total_results + disabled_symbols + trades recentes</td>
        </tr>
        <tr>
          <td><span class="tag tag-indigo">GET</span></td>
          <td><code>/api/daily-pnl-by-coin</code></td>
          <td>JSON</td>
          <td>P&L diÃ¡rio agrupado por sÃ­mbolo (7 dias)</td>
        </tr>
        <tr>
          <td><span class="tag tag-green">POST</span></td>
          <td><code>/api/resume/&lt;symbol&gt;</code></td>
          <td>JSON</td>
          <td>Remove sÃ­mbolo de disabled_symbols (reabilita a coin)</td>
        </tr>
      </tbody>
    </table>
  </div>
</section>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SEÃ‡ÃƒO 10 â€” NOTIFICAÃ‡Ã•ES TELEGRAM
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<section id="notificacoes" class="animate-on-scroll">
  <div class="section-header">
    <div class="section-icon icon-indigo">ğŸ“±</div>
    <h2>NotificaÃ§Ãµes Telegram</h2>
  </div>

  <div class="info-box" style="margin-bottom:24px;">
    <h3>âš™ï¸ Como funciona</h3>
    <p>
      O <code>notifier.py</code> usa <code>subprocess.run()</code> para chamar o binÃ¡rio <code>openclaw</code>.<br/>
      BinÃ¡rio resolvido via <code>shutil.which("openclaw")</code> com fallback para <code>/home/clawdbot/.npm-global/bin/openclaw</code>.<br/>
      Destino: chat do AndrÃ© no Telegram (ID <code>7965086167</code>).<br/>
      Command: <code>openclaw message send --channel telegram --target 7965086167 --message "..."</code>
    </p>
  </div>

  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>Evento</th>
          <th>Quando dispara</th>
          <th>Emoji</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td class="fw700">Bot iniciado</td>
          <td>Ao subir o <code>trading-bot.service</code> (ou reiniciar)</td>
          <td>ğŸš€</td>
        </tr>
        <tr>
          <td class="fw700">Bot parado manualmente</td>
          <td>SIGTERM ou SIGINT recebido</td>
          <td>â¹ï¸</td>
        </tr>
                <tr>
          <td class="fw700">Bot pausado (circuit breaker)</td>
          <td>Ao iniciar com circuit breaker ativo no banco</td>
          <td>â¸ï¸</td>
        </tr>
        <tr>
          <td class="fw700">Strike de drawdown (aviso)</td>
          <td>Coin com drawdown &gt;25% â€” strike 1 ou 2 de 3</td>
          <td>âš ï¸</td>
        </tr>
        <tr>
          <td class="fw700">Coin desabilitada (3 strikes)</td>
          <td>3 strikes em 30 minutos para a mesma coin</td>
          <td>â›”</td>
        </tr>
        <tr>
          <td class="fw700">Coin desabilitada (perda diÃ¡ria)</td>
          <td>Perda diÃ¡ria da coin ultrapassa $10 USDT</td>
          <td>â›”</td>
        </tr>
        <tr>
          <td class="fw700">Stop-loss mode ativado</td>
          <td>PreÃ§o caiu &gt;12% do centro do grid</td>
          <td>âš ï¸</td>
        </tr>
        <tr>
          <td class="fw700">Stop-loss mode desativado</td>
          <td>PreÃ§o se recuperou (queda &lt;6%)</td>
          <td>âœ…</td>
        </tr>
        <tr>
          <td class="fw700">Stop-loss total</td>
          <td>PreÃ§o caiu &gt;15% â€” posiÃ§Ãµes fechadas, coin desabilitada</td>
          <td>ğŸ›‘</td>
        </tr>
        <tr>
          <td class="fw700">Balance floor</td>
          <td>Coin perdeu &gt;40% do capital alocado ($20)</td>
          <td>ğŸ›‘</td>
        </tr>
        <tr>
          <td class="fw700">Auto-disable (perda % do capital)</td>
          <td>Perda diÃ¡ria &gt;20% ou total &gt;30% do capital alocado</td>
          <td>âš ï¸</td>
        </tr>
      </tbody>
    </table>
  </div>
</section>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SEÃ‡ÃƒO 11 â€” COMO RECRIAR DO ZERO
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<section id="recriar" class="animate-on-scroll">
  <div class="section-header">
    <div class="section-icon icon-green">ğŸ”¨</div>
    <h2>Como Recriar do Zero</h2>
  </div>

  <p class="text-muted" style="margin-bottom:24px;font-size:0.95rem;">Passo a passo completo para recriar toda a infraestrutura numa nova VPS ou apÃ³s reset total.</p>

  <div class="step-list">

    <div class="step">
      <div class="step-num">1</div>
      <div class="step-content">
        <h4>Clonar o repositÃ³rio</h4>
        <p>O cÃ³digo estÃ¡ no GitHub da AndreClawdTeam.</p>
        <div class="code-wrap" style="margin-top:8px;">
          <span class="code-label">bash</span>
          <pre class="no-label">git clone https://github.com/AndreClawdTeam/trading-bot.git
cd trading-bot</pre>
        </div>
      </div>
    </div>

    <div class="step">
      <div class="step-num">2</div>
      <div class="step-content">
        <h4>Instalar PostgreSQL 16</h4>
        <div class="code-wrap" style="margin-top:8px;">
          <span class="code-label">bash</span>
          <pre class="no-label">sudo apt update && sudo apt install -y postgresql postgresql-contrib
sudo -u postgres psql -c "CREATE USER andre WITH PASSWORD 'u+oVn9kpPEL5MvibJgQgCJj8gHEXAK50';"
sudo -u postgres psql -c "CREATE DATABASE trading OWNER andre;"
sudo systemctl enable postgresql && sudo systemctl start postgresql</pre>
        </div>
      </div>
    </div>

    <div class="step">
      <div class="step-num">3</div>
      <div class="step-content">
        <h4>Criar as tabelas manualmente</h4>
        <div class="code-wrap" style="margin-top:8px;">
          <span class="code-label">bash</span>
          <pre class="no-label">psql "postgresql://andre:u+oVn9kpPEL5MvibJgQgCJj8gHEXAK50@localhost:5432/trading" -c "
CREATE TABLE IF NOT EXISTS trades (
    id SERIAL PRIMARY KEY, symbol VARCHAR(20) DEFAULT 'PEPE/USDT',
    side VARCHAR(4) NOT NULL, amount NUMERIC(20,10) NOT NULL,
    price NUMERIC(20,10) NOT NULL, value_usdt NUMERIC(16,6),
    fee_usdt NUMERIC(16,8) DEFAULT 0, profit_usdt NUMERIC(16,8) DEFAULT 0,
    profit_pct NUMERIC(10,6) DEFAULT 0, mode VARCHAR(10) DEFAULT 'paper',
    grid_level INT, created_at TIMESTAMPTZ DEFAULT NOW()
);
CREATE TABLE IF NOT EXISTS total_results (
    id INT PRIMARY KEY DEFAULT 1, updated_at TIMESTAMPTZ DEFAULT NOW(),
    starting_balance NUMERIC(14,4) DEFAULT 120.0,
    current_balance NUMERIC(14,4) DEFAULT 120.0,
    net_profit_usdt NUMERIC(14,6) DEFAULT 0,
    net_profit_pct NUMERIC(10,4) DEFAULT 0,
    win_rate NUMERIC(6,2) DEFAULT 0, total_trades INT DEFAULT 0,
    winning_trades INT DEFAULT 0, peak_balance NUMERIC(14,4) DEFAULT 120.0,
    max_drawdown_pct NUMERIC(10,4) DEFAULT 0
);
INSERT INTO total_results (id) VALUES (1) ON CONFLICT DO NOTHING;
CREATE TABLE IF NOT EXISTS daily_results (
    id SERIAL PRIMARY KEY, date DATE UNIQUE NOT NULL,
    total_trades INT DEFAULT 0, winning_trades INT DEFAULT 0,
    losing_trades INT DEFAULT 0, gross_profit NUMERIC(14,6) DEFAULT 0,
    gross_loss NUMERIC(14,6) DEFAULT 0, net_profit NUMERIC(14,6) DEFAULT 0,
    win_rate NUMERIC(6,2) DEFAULT 0, starting_balance NUMERIC(14,4) DEFAULT 0,
    ending_balance NUMERIC(14,4) DEFAULT 0
);"</pre>
        </div>
      </div>
    </div>

    <div class="step">
      <div class="step-num">4</div>
      <div class="step-content">
        <h4>Criar virtualenv e instalar dependÃªncias do bot</h4>
        <div class="code-wrap" style="margin-top:8px;">
          <span class="code-label">bash</span>
          <pre class="no-label">python3 -m venv /home/clawdbot/.openclaw/workspace/venv
source /home/clawdbot/.openclaw/workspace/venv/bin/activate
pip install -r requirements.txt</pre>
        </div>
      </div>
    </div>

    <div class="step">
      <div class="step-num">5</div>
      <div class="step-content">
        <h4>Instalar Flask para o dashboard</h4>
        <div class="code-wrap" style="margin-top:8px;">
          <span class="code-label">bash</span>
          <pre class="no-label"># Com linuxbrew python (conforme configuraÃ§Ã£o atual):
/home/linuxbrew/.linuxbrew/bin/pip3 install flask flask-cors psycopg2-binary</pre>
        </div>
      </div>
    </div>

    <div class="step">
      <div class="step-num">6</div>
      <div class="step-content">
        <h4>Testar o bot manualmente</h4>
        <div class="code-wrap" style="margin-top:8px;">
          <span class="code-label">bash</span>
          <pre class="no-label">cd /home/clawdbot/workspace/coding/trading-bot
/home/clawdbot/.openclaw/workspace/venv/bin/python3 bot.py
# Ctrl+C para parar</pre>
        </div>
      </div>
    </div>

    <div class="step">
      <div class="step-num">7</div>
      <div class="step-content">
        <h4>Criar os arquivos .service e ativar no systemd</h4>
        <div class="code-wrap" style="margin-top:8px;">
          <span class="code-label">bash</span>
          <pre class="no-label">mkdir -p ~/.config/systemd/user/
# Criar trading-bot.service e trading-dashboard.service
# (conteÃºdo completo na seÃ§Ã£o Systemd Services acima)
systemctl --user daemon-reload
systemctl --user enable trading-bot trading-dashboard
systemctl --user start trading-bot trading-dashboard
sudo loginctl enable-linger clawdbot  # persist after logout</pre>
        </div>
      </div>
    </div>

    <div class="step">
      <div class="step-num">8</div>
      <div class="step-content">
        <h4>Verificar dashboard</h4>
        <p>Abrir <a href="http://138.197.19.184:8766" target="_blank" style="color:#a5b4fc;">http://138.197.19.184:8766</a> â€” deve mostrar as 6 coins ativas e mÃ©tricas zeradas ou acumuladas.</p>
      </div>
    </div>

  </div>
</section>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SEÃ‡ÃƒO 12 â€” COMO IR PARA LIVE MODE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<section id="live" class="animate-on-scroll">
  <div class="section-header">
    <div class="section-icon icon-yellow">ğŸ’°</div>
    <h2>Como Ir para Live Mode</h2>
  </div>

  <div class="warning-box">
    <h3>âš ï¸ Paper Mode Ativo â€” Nenhuma Ordem Real</h3>
    <p>Atualmente <code>PAPER_MODE = True</code> em <code>config.py</code>. Toda a lÃ³gica funciona com preÃ§os reais mas sem executar ordens na exchange. Para ir live, siga os passos abaixo.</p>
  </div>

  <div class="step-list" style="margin-top:24px;">
    <div class="step">
      <div class="step-num">1</div>
      <div class="step-content">
        <h4>Criar conta na OKX</h4>
        <p>A OKX nÃ£o tem geo-block para esta VPS. Acessar <a href="https://www.okx.com" target="_blank" style="color:#a5b4fc;">okx.com</a>, criar conta e completar KYC bÃ¡sico.</p>
      </div>
    </div>
    <div class="step">
      <div class="step-num">2</div>
      <div class="step-content">
        <h4>Gerar API Key na OKX</h4>
        <p>Painel OKX â†’ Account â†’ API â†’ Criar Key. PermissÃ£o: <strong>Trade Only</strong> (sem Withdrawal). IP Whitelist: <code>138.197.19.184</code>. Salvar API Key, Secret e Passphrase.</p>
      </div>
    </div>
    <div class="step">
      <div class="step-num">3</div>
      <div class="step-content">
        <h4>Editar config.py</h4>
        <div class="code-wrap" style="margin-top:8px;">
          <span class="code-label">config.py</span>
          <pre class="no-label">PAPER_MODE = False   # â† mudar para False
API_KEY    = "sua_api_key_aqui"
API_SECRET = "seu_api_secret_aqui"
# Se OKX exigir passphrase, adicionar: API_PASSPHRASE = "..."</pre>
        </div>
      </div>
    </div>
    <div class="step">
      <div class="step-num">4</div>
      <div class="step-content">
        <h4>Implementar execuÃ§Ã£o real de ordens</h4>
        <p class="text-muted">Os mÃ©todos <code>_fill_buy()</code> e <code>_fill_sell()</code> em <code>strategy.py</code> precisam ser adaptados para chamar <code>get_ccxt_exchange().create_order()</code> quando <code>PAPER_MODE = False</code>. A funÃ§Ã£o <code>get_ccxt_exchange()</code> jÃ¡ existe em <code>exchange.py</code> e retorna a instÃ¢ncia ccxt autenticada.</p>
      </div>
    </div>
    <div class="step">
      <div class="step-num">5</div>
      <div class="step-content">
        <h4>Reiniciar o bot</h4>
        <div class="code-wrap" style="margin-top:8px;">
          <span class="code-label">bash</span>
          <pre class="no-label">systemctl --user restart trading-bot
tail -f /home/clawdbot/workspace/coding/trading-bot/bot.log</pre>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SEÃ‡ÃƒO 13 â€” COMANDOS ÃšTEIS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<section id="comandos" class="animate-on-scroll">
  <div class="section-header">
    <div class="section-icon icon-cyan">ğŸ”§</div>
    <h2>Comandos Ãšteis</h2>
  </div>

  <div style="display:flex;flex-direction:column;gap:24px;">

    <div>
      <h3 style="font-size:1rem;font-weight:700;margin-bottom:12px;">ğŸ“‹ psql â€” Queries de Monitoramento</h3>
      <div class="code-wrap">
        <span class="code-label">psql</span>
        <pre class="no-label">-- Conectar
psql "postgresql://andre:u+oVn9kpPEL5MvibJgQgCJj8gHEXAK50@localhost:5432/trading"

-- MÃ©tricas globais
SELECT current_balance, net_profit_usdt, net_profit_pct, win_rate,
       total_trades, max_drawdown_pct FROM total_results WHERE id=1;

-- Ãšltimos 20 trades
SELECT symbol, side, price, profit_usdt, created_at
FROM trades ORDER BY created_at DESC LIMIT 20;

-- P&amp;L por coin (total)
SELECT symbol, SUM(profit_usdt) AS pnl, COUNT(*) AS trades
FROM trades GROUP BY symbol ORDER BY pnl DESC;

-- P&amp;L por coin (hoje)
SELECT symbol, SUM(profit_usdt) AS daily_pnl
FROM trades
WHERE DATE(created_at AT TIME ZONE 'UTC') = CURRENT_DATE
GROUP BY symbol ORDER BY daily_pnl DESC;

-- Coins desabilitadas
SELECT symbol, reason, total_pnl, disabled_at FROM disabled_symbols ORDER BY disabled_at DESC;

-- Reabilitar coin
DELETE FROM disabled_symbols WHERE symbol = 'PEPE/USDT';

-- Ativar/desativar circuit breaker global
UPDATE bot_state SET trading_enabled = FALSE WHERE id = 1;  -- pausa
UPDATE bot_state SET trading_enabled = TRUE  WHERE id = 1;  -- retoma</pre>
      </div>
    </div>

    <div>
      <h3 style="font-size:1rem;font-weight:700;margin-bottom:12px;">âš™ï¸ Systemctl</h3>
      <div class="code-wrap">
        <span class="code-label">bash</span>
        <pre class="no-label">systemctl --user status trading-bot trading-dashboard
systemctl --user restart trading-bot
systemctl --user restart trading-dashboard
journalctl --user -u trading-bot -f
journalctl --user -u trading-dashboard -f
tail -f /home/clawdbot/workspace/coding/trading-bot/bot.log</pre>
      </div>
    </div>

    <div>
      <h3 style="font-size:1rem;font-weight:700;margin-bottom:12px;">ğŸ Testar Price Feed</h3>
      <div class="code-wrap">
        <span class="code-label">bash</span>
        <pre class="no-label">cd /home/clawdbot/workspace/coding/trading-bot
/home/clawdbot/.openclaw/workspace/venv/bin/python3 -c "
from exchange import get_price
coins = ['PEPE/USDT','SHIB/USDT','BONK/USDT','FLOKI/USDT','DOGE/USDT','WIF/USDT']
for c in coins: print(f'{c}: {get_price(c)}')
"</pre>
      </div>
    </div>

    <div>
      <h3 style="font-size:1rem;font-weight:700;margin-bottom:12px;">ğŸ”” Testar NotificaÃ§Ã£o Manual</h3>
      <div class="code-wrap">
        <span class="code-label">bash</span>
        <pre class="no-label">/home/clawdbot/.npm-global/bin/openclaw message send   --channel telegram --target 7965086167 --message "ğŸ”” Teste manual"</pre>
      </div>
    </div>

  </div>
</section>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SEÃ‡ÃƒO 14 â€” ESTADO ATUAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<section id="estado" class="animate-on-scroll">
  <div class="section-header">
    <div class="section-icon icon-green">ğŸ“¡</div>
    <h2>Estado Atual</h2>
  </div>

  <div class="success-box" style="margin-bottom:24px;">
    <h3>âœ… Bot Operacional â€” Paper Mode</h3>
    <p>
      Rodando desde <strong>20/02/2026</strong> na VPS <code>138.197.19.184</code>.<br/>
      6 coins ativas, capital total de $120 USDT simulado.<br/>
      Nenhuma ordem real executada â€” paper mode com preÃ§os reais da OKX.
    </p>
  </div>

  <div class="stat-row">
    <div class="stat-card">
      <div class="stat-value" style="font-size:1.1rem;background:linear-gradient(135deg,#86efac,#22c55e);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;">PAPER</div>
      <div class="stat-label">Modo de operaÃ§Ã£o</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">6</div>
      <div class="stat-label">Coins ativas</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">$120</div>
      <div class="stat-label">Capital total USDT</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" style="font-size:1rem;">OKX</div>
      <div class="stat-label">Exchange primÃ¡ria</div>
    </div>
    <div class="stat-card">
      <div class="stat-value" style="font-size:0.9rem;">20/02/26</div>
      <div class="stat-label">InÃ­cio da operaÃ§Ã£o</div>
    </div>
  </div>

  <div class="table-wrap" style="margin-top:24px;">
    <table>
      <thead>
        <tr>
          <th>Componente</th>
          <th>Status</th>
          <th>LocalizaÃ§Ã£o</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td class="fw700">trading-bot.service</td>
          <td><span class="tag tag-green">âœ… Running</span></td>
          <td>VPS 138.197.19.184 Â· restart 30s</td>
        </tr>
        <tr>
          <td class="fw700">trading-dashboard.service</td>
          <td><span class="tag tag-green">âœ… Running</span></td>
          <td>VPS :8766 Â· restart 5s</td>
        </tr>
        <tr>
          <td class="fw700">PostgreSQL 16</td>
          <td><span class="tag tag-green">âœ… Running</span></td>
          <td>localhost:5432</td>
        </tr>
        <tr>
          <td class="fw700">OKX Price Feed</td>
          <td><span class="tag tag-green">âœ… OK</span></td>
          <td>api.okx.com (sem geo-block)</td>
        </tr>
        <tr>
          <td class="fw700">KuCoin Fallback</td>
          <td><span class="tag tag-green">âœ… OK</span></td>
          <td>api.kucoin.com</td>
        </tr>
        <tr>
          <td class="fw700">Telegram Notifier</td>
          <td><span class="tag tag-green">âœ… OK</span></td>
          <td>openclaw CLI Â· PATH configurado</td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="info-box" style="margin-top:24px;">
    <h3>ğŸ”® PrÃ³ximos Passos para Live Mode</h3>
    <p>
      1. Criar conta OKX + gerar API keys (Trade Only, sem Withdrawal)<br/>
      2. Implementar execuÃ§Ã£o real em <code>strategy.py</code> (<code>create_order()</code> nos fills)<br/>
      3. Depositar $120 USDT na conta Spot OKX<br/>
      4. Editar <code>config.py</code>: <code>PAPER_MODE = False</code> + API keys<br/>
      5. <code>systemctl --user restart trading-bot</code>
    </p>
  </div>

  <div class="inline-links" style="margin-top:24px;">
    <a href="http://138.197.19.184:8766" target="_blank" class="btn btn-primary">ğŸ“Š Dashboard ao Vivo</a>
    <a href="https://github.com/AndreClawdTeam/trading-bot" target="_blank" class="btn btn-secondary">ğŸ’» GitHub Repo</a>
  </div>
</section>

</main>

<!-- â•â•â•â•â•â•â•â•â•â•â• FOOTER â•â•â•â•â•â•â•â•â•â•â• -->
<footer>
  <p>
    <span>ğŸ¤– AndreClawdTeam Trading Bot</span> â€” Fonte da Verdade<br/>
    Documentado por Johnny Juvenil Â· Fevereiro 2026<br/>
    <a href="https://github.com/AndreClawdTeam/trading-bot" target="_blank" style="color:var(--accent);">github.com/AndreClawdTeam/trading-bot</a>
    &nbsp;Â·&nbsp;
    <a href="http://138.197.19.184:8766" target="_blank" style="color:var(--accent);">Dashboard ao vivo</a>
  </p>
</footer>

<script>
  function toggleSource(id) {
    const el = document.getElementById(id);
    const body = el.querySelector('.source-body');
    const isOpen = el.classList.contains('open');
    if (isOpen) {
      el.classList.remove('open');
      body.style.maxHeight = '0';
    } else {
      el.classList.add('open');
      body.style.maxHeight = body.scrollHeight + 'px';
    }
  }

  document.querySelectorAll('.source-file.open').forEach(el => {
    const body = el.querySelector('.source-body');
    body.style.maxHeight = body.scrollHeight + 'px';
  });

  const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) entry.target.classList.add('visible');
    });
  }, { threshold: 0.05, rootMargin: '0px 0px -40px 0px' });

  document.querySelectorAll('.animate-on-scroll').forEach(el => observer.observe(el));

  const navLinks = document.querySelectorAll('nav a');
  const navObserver = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        navLinks.forEach(link => { link.style.color = ''; link.style.borderColor = ''; });
        const activeLink = document.querySelector('nav a[href="#' + entry.target.id + '"]');
        if (activeLink) { activeLink.style.color = '#a5b4fc'; activeLink.style.borderColor = '#6366f1'; }
      }
    });
  }, { threshold: 0.2 });

  document.querySelectorAll('section[id]').forEach(section => navObserver.observe(section));
</script>

</body>
</html>